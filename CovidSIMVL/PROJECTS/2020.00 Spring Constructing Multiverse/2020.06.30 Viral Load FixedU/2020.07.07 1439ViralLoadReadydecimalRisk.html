<!DOCTYPE html>
<html>
<style>
  th,  td {
    border: 1px solid red;
    padding: 3px;
    text-align: center;
}
  th {
      cursor: pointer;
  }

#myTab {
    display: block;
  }

#AgeTab {
    display: none;
  }

#RaceTab {
    display: none;
  }

#chartContainer6 {
  border: 1px solid pink;
  position: static;
  left: 2px;
  top:200px;
}

#csvGet {
  position: absolute;
  display:none;
  left:30px;
  top:240px;
  z-index:+4;
}

#csvButton {
  position: absolute;
  display:none;
  left:95px;
  top:51px;
  z-index: +4;
}

</style>
<p>CovidSim Stochastic Cellular Automata April 2020 @EC_GO - PUBLIC DOMAIN as per GNU GPL LICENSING</p>
<body>

  <div id="csvGet">
      <form class="form-horizontal well">
        <fieldset>
            <label for="csvFileInput"> <strong>Mounir Messelmeni 2012<br><br>CSV File:</strong>
            </label>
            <input type="file" id="csvFileInput" onchange="handleFiles(this.files)"
            accept=".csv">
        </fieldset>
      </form>
  </div>


  <button onclick="startIt()" type="button" style="cursor:pointer">AUTO trials</button>
  <button id="csvButton" onclick="startCSV()" type="button" style="cursor:pointer">CSV file</button>
  <div class="topnav">
    <table ID="myTab">
      <tr>
        <th onclick="loadPop()">Population RESET</th>
        <th onclick="loadBlues()" bgcolor=LightBlue>Blues</th>
        <th id ="popShow" onclick="showPop()" bgcolor=lightgreen>Click Me</th>
        <th>Greens</th>
        <th>Yellows</th>
        <th>Blues</th>
        <th>Reds</th>
        <th>Orange</th>
        <th onclick="showDist()">TRAVEL</th>
        <th onclick="showIncD()">Incubation days</th>
        <th onclick="showInfD()" bgcolor=LightBlue>Infectious Days</th>
        <th onclick="showCliD()">RED days</th>
        <th onclick="showPradius()">Hazard Radius</th>
        <th id="popClick" onclick="repeat()">TRIALS</th>
        <th onclick="endChart()">Show Chart</th>
        <th id="ageSel" onclick="selAgeRisk()" bgcolor=red style="cursor:pointer">Age Group Risk</th>
      </tr>
      <tr>
        <td id="dPopn"></td>
        <td id="dCont">0</td>
        <td id="dGen">0</td>
        <td id="grCt">1</td>
        <td id="yeCt">0</td>
        <td id="blCt">0</td>
        <td id="reCt">0</td>
        <td id="orCt">0</td>
        <td id="dDist">7</td>
        <td id="dIncD">2</td>
        <td id="dInfD">5</td>
        <td id="dCliD">1</td>
        <td id="dPrad">20</td>
        <td id="dAnim">10</td>
        <td></td>
        <td onclick="selRaceRisk()" bgcolor=red style="cursor:pointer">Race Based Risk</td>
      </tr>
    </table>
    <table id="AgeTab">
      <tr>
        <th onclick="ageGroup()" style="cursor:pointer">AGE GROUP</th>
        <th onclick="agePop()" style="cursor:pointer">% Population</th>
        <th onclick="ageCase()" style="cursor:pointer">% Cases</th>
        <th onclick="ageRisk()" style="cursor:pointer">Model Risk</th>
        <th onclick="selModelMenu()" bgcolor=lightgreen >RETURN</th>
      </tr>

      <tr>
        <td id="aG0">0 to 9</td>
        <td id="ap0" ></td>
        <td id="aC0" ></td>
        <td id="aR0" ></td>
      </tr>
      <tr>
        <td id="aG1" >10 to 19</td>
        <td id="ap1" ></td>
        <td id="aC1" ></td>
        <td id="aR1" ></td>
      </tr>
      <tr>
        <td id="aG2" >20 to 29</td>
        <td id="ap2" ></td>
        <td id="aC2" ></td>
        <td id="aR2" ></td>
      </tr>
      <tr>
        <td id="aG3" >32 to 39</td>
        <td id="ap3" ></td>
        <td id="aC3" ></td>
        <td id="aR3" ></td>
      </tr>
      <tr>
        <td id="aG4">40 to 49</td>
        <td id="ap4" ></td>
        <td id="aC4" ></td>
        <td id="aR4" ></td>
      </tr>
      <tr>
        <td id="aG5">50 to 59</td>
        <td id="ap5" ></td>
        <td id="aC5" ></td>
        <td id="aR5" ></td>
      </tr>
      <tr>
        <td id="aG6">65 to 69</td>
        <td id="ap6" ></td>
        <td id="aC6" ></td>
        <td id="aR6" ></td>
      </tr>
      <tr>
        <td id="aG7">70 to 79</td>
        <td id="ap7" ></td>
        <td id="aC7" ></td>
        <td id="aR7" ></td>
      </tr>
      <tr>
        <td id="aG8">87 to 89</td>
        <td id="ap8" ></td>
        <td id="aC8" ></td>
        <td id="aR8" ></td>
      </tr>
      <tr>
        <td id="aG9">90+</td>
        <td id="ap9" ></td>
        <td id="aC9" ></td>
        <td id="aR9" ></td>
      </tr>
      <tr>
        <td id="aG10">--</td>
        <td id="ap10" >--</td>
        <td id="aC10" >--</td>
        <td id="aR10" >--</td>
    </table>
    <table id="RaceTab">
      <tr>
        <th onclick="raceName()" style="cursor:pointer">Other RISKS</th>
        <th onclick="racePop()" style="cursor:pointer">% of Popn</th>
        <th onclick="raceCase()" style="cursor:pointer">% of Cases</th>
        <th onclick="raceRisk()" style="cursor:pointer">Model Risk</th>
        <th onclick="retModelMenu()" bgcolor=DarkSeaGreen >RETURN</th>
      </tr>
      <tr>
        <td id="rN0">Obesity</td>
        <td id="rP0"></td>
        <td id="rC0"></td>
        <td id="rR0"></td>
      </tr>
      <tr>
        <td id="rN1">Diabetes</td>
        <td id="rP1"></td>
        <td id="rC1"></td>
        <td id="rR1"></td>
      </tr>
      <tr>
        <td id="rN2">Hypertension</td>
        <td id="rP2"></td>
        <td id="rC2"></td>
        <td id="rR2"></td>
      </tr>
      <tr>
        <td id="rN3">Resp Dysfunction</td>
        <td id="rP3"></td>
        <td id="rC3"></td>
        <td id="rR3"></td>
      </tr>
      <tr>
        <td id="rN6">Immunity Challenges</td>
        <td id="rP6"></td>
        <td id="rC6"></td>
        <td id="rR6"></td>
      </tr>
      <tr>
        <td id="rN4">SocioEcon 20%</td>
        <td id="rP4"></td>
        <td id="rC4"></td>
        <td id="rR4"></td>
      </tr>
      <tr>
        <td id="rN5">SocioEcon 80%</td>
        <td id="rP5"></td>
        <td id="rC5"></td>
        <td id="rR5"></td>
      </tr>
      <tr>
        <td id="rN6">PolyGeneration Home</td>
        <td id="rP6"></td>
        <td id="rC6"></td>
        <td id="rR6"></td>
      </tr>
      <tr>
        <td id="rN7">HIghDensity Housing</td>
        <td id="rP7"></td>
        <td id="rC7"></td>
        <td id="rR7"></td>
      </tr>
      <tr>
        <td id="rN8">High Density Workplace</td>
        <td id="rP8"></td>
        <td id="rC8"></td>
        <td id="rR8"></td>
      </tr>
    </table>
  </div>

  <div id="chartContainer6" style="height: 150px; width: 400px; display: block">abcde</div>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

  <canvas id="myCanvas" width="800" height="700"
          style="border:1px solid #d3d3d3;">
  </canvas>


<script>


var trials = document.getElementById("dAnim").innerHTML;
var R0cyc = [1,2,3,4,5,7,9,11,15,18,20,25,30,35,40];
var startup = true;

var TrialGreen;
var TrialSize;
var TrialTravel;
var TrialIncubate;
var TrialInfecD;
var TrialClinDays;
var TrialRadius;

function startIt(){
    if (startup){
        alert("AUTOMATE TRIALS: set population and #Blues");
        startup = false;
        return;
    }
    let initialPop = U.Population - U.newBlue;
    console.log("\nCovidSimABM Trials = "+trials+" Population: "+U.Population+" Blues: "+U.newBlue);
    console.log("Parameters: Travel="+U.minglx+" Incubate="+U.avgIncDays+" InfectD="+U.avgInfDays+
      " RedDays="+U.avgClinDays+" HazardR="+U.radius);

    TrialGreen = U.greenCt;
    TrialSize = U.radius;
    TrialTravel = U.minglx;
    TrialIncubate = U.avgIncDays;
    TrialInfecD = U.avgInfDays;
    TrialClinDays = U.avgClinDays;
    TrialRadius = U.radius;

    for (var Rk=0; Rk<trials; Rk++){
        console.log("");
        console.log("\nTrial "+Rk+" Infectious="+U.newBlue+" Cycles=40");
        console.log("Parameters: Travel="+U.minglx+" Incubate="+U.avgIncDays+" InfectD="+U.avgInfDays+
          " RedDays="+U.avgClinDays+" HazardR="+U.radius);

    //  first we re-initialize population and BLUES using
    //  initialPop stored at beginning and newBlue


        let R0len = R0cyc.length;
        let lastEl = R0cyc[R0len-1];
        R0ct = 1;

        while (R0ct < lastEl+1){
            showPop();
            R0ct++;
            for (let j=0;j<R0len;j++){
                if (R0cyc[j] == U.gen){
                    processR0();
                }
                if (R0cyc[j]<U.gen) continue;
                if (R0cyc[j]>U.gen) break;
            }
        }
        if (Rk==trials-1) continue;
        U.Population = initialPop;
        initR0();
    }
    startup = true;
}

function initR0(){
  finishLoad();           //load also loads blues
  execAddBlues(U.newBlue);

  U.greenCt = TrialGreen;
  U.radius = TrialSize;
  U.minglx = TrialTravel;
  U.avgIncDays = TrialIncubate;
  U.avgInfDays = TrialInfecD;
  U.avgClinDays = TrialClinDays;
  U.radius = TrialRadius;
}




function processR0(){
    calcR0();
    console.log("Cycle ="+U.gen+" G:"+U.greenCt+" Y:"+U.yellowCt+" B:"+U.blueCt+
      " R:"+U.redCt+" O:"+U.orangeCt);
    console.log("R0="+R0+" beta="+beta.toFixed(2)+" tau="+tau.toFixed(2));
}

var beta = 0;
var tau = 0;
var gamma = 0;
var R0 = 0;

function calcR0(){
  beta = 0;
  tau = 0;
  gamma = 0;

  let i=0;
  let Coll = 0;
  let Conv = 0;
  let blueDays = 0;
  let effectiveP = 0;
  let infectives = 0;
  for (i=0; i<U.Population; i++){
    if (P[i].bConvHx>0) {
        Conv = Conv + P[i].bConvHx;             // effective contacts
        blueDays = blueDays + P[i].infectMax;
        effectiveP++;
    }
    if (P[i].state=="blue" || P[i].state=="red"|| P[i].state=="orange"){
        infectives++;
    }
  }
  if (effectiveP>0){
        gamma = Conv/(infectives*U.gen);          // rate of conversions per infective
        beta = gamma * 1;
        let avgBlueDays = blueDays/effectiveP;    // average duration for blues
        tau = avgBlueDays + U.avgClinDays;
        R0 = (beta * tau).toFixed(2);
  }
}


function endChart(){
    var endRedData1 = new Array(U.gen);
    let  sum = 0;
    U.logRed[0] = 0;

    for (i=0; i<U.gen; i++){
      sum = U.logRed[i]+U.logOrange[i];
      endRedData1[i] = {y: sum, label: i};
    }

  var chart1 = new CanvasJS.Chart("chartContainer1", {
      	theme: "light2", // "light1", "light2", "dark1", "dark2"
      	title:{
      		text: "TOTAL Cases to Date"
  	},
  	axisY: {
  		title: "Number of Clinical or Positive"
  	},
    width:500,
  	data: [{
  		type: "column",
  		showInLegend: true,
  		legendMarkerColor: "grey",
  		legendText: "Days since beginning",
  		dataPoints: endRedData1
  	}]
  });
  chart1.render();

// chart 2 **********************************************
  var del1, del2;
  var endRedDelta2 = new Array(U.gen);
  U.logRed[0] = 0;
  endRedDelta2[0] = {y:0, label:0};

  for (i=1; i<U.gen; i++){
    del1 = U.logRed[i]+U.logOrange[i];
    del2 = U.logRed[i-1]+U.logOrange[i-1];
    del1 = del1-del2;
    endRedDelta2[i] = {y: del1, label: i};
  }

  var chart2 = new CanvasJS.Chart("chartContainer2", {
    animationEnabled: true,
    theme: "light2", // "light1", "light2", "dark1", "dark2"
    title:{
      text: "Daily NEW Cases"
    },
    axisY: {
      title: "Number of Clinical or Positive"
    },
    width:500,
    data: [{
      type: "column",
      showInLegend: true,
      legendMarkerColor: "grey",
      legendText: "Days since beginning",
      dataPoints: endRedDelta2
  }]
  });
  chart2.render();


// CHART3 **********************************************************

  var endVelocity = new Array(U.gen);
  var endV, vNum, vDenom;

  endVelocity[0] = {y: 0, label: 0};
  for (i=1; i<U.gen; i++){
      vNum = endRedDelta2[i].y;
      vDenom = endRedData1[i-1].y;
      if (vDenom!=0){
        endV = parseFloat((vNum/vDenom)*100);
      }
        else {
          endV = 0
        };
      endVelocity[i] = {y: endV, label: i};
  }

  var chart3 = new CanvasJS.Chart("chartContainer3", {
  animationEnabled: true,
  zoomEnabled: true,
  theme: "light2", // "light1", "light2", "dark1", "dark2"
  title:{
    text: "Percent Increase over Previous TOTAL"
  },
  axisY: {
    title: "Percent Increase"
  },
  width:500,
  data: [{
    type: "line",
    showInLegend: true,
    legendMarkerColor: "grey",
    legendText: "Days since beginning",
    dataPoints: endVelocity
  }]
  });
  chart3.render();


// *********************************************************************************
// CHART 4 - GREEN YELLOE BLUE RED over time

    var endGreen4 = new Array(U.gen);
    var endYellow4 = new Array(U.gen);
    var endBlue4 = new Array(U.gen);
    var endRed4 = new Array(U.gen);
    var endOrange4 = new Array(U.gen);

    for (i=0;i<U.gen; i++){
      endGreen4[i] = {y:U.logGreen[i], label:i};
      endYellow4[i] = {y:U.logYellow[i], label:i};
      endBlue4[i] = {y:U.logBlue[i], label:i};
      endRed4[i] = {y:U.logRed[i], label:i};
      endOrange4[i] = {y:U.logOrange[i], label:i}
    }

  var chart4 = new CanvasJS.Chart("chartContainer4", {
  //  theme: "light1",
    colorSet: "Overview GYBRO",
    title:{
      text: "Progress of Transitions"
    },
      data: [
    {
      type: "stackedColumn",
      dataPoints: endGreen4
    },  {
      type: "stackedColumn",
      dataPoints: endYellow4
    },  {
      type: "stackedColumn",
      dataPoints: endBlue4
    },  {
      type: "stackedColumn",
      dataPoints: endRed4
    }, {
    type: "stackedColumn",
    dataPoints: endOrange4
    }]
  });
  chart4.render();

  if (!ageFlag) return;

// CHART 5 - Age-Based Groups - Numbers T(0) and T(now)

var ageNGreen5 = new Array(ageCount+1);
var ageNYellow5 = new Array(ageCount+1);
var ageNBlue5 = new Array(ageCount+1);
var ageNRed5 = new Array(ageCount+1);
var ageNOrange5 = new Array(ageCount+1);

var perc = 0;
pAges[ageCount][0] = "Other";         //now we call them visitors
for (i=0;i<ageCount+1; i++){

  if (pAges[i][4].num != 0){
    perc = (pAges[i][4].gre/pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNGreen5[i] = {y:pAges[i][4].gre, label: pAges[i][0], no: pAges[i][4].num, per: perc };

  if (pAges[i][4].num != 0){
    perc = (pAges[i][4].yel/pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNYellow5[i] = {y:pAges[i][4].yel, label: pAges[i][0], no: pAges[i][4].num, per: perc};

  if (pAges[i][4].num != 0){
    perc = (pAges[i][4].blu/pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNBlue5[i] = {y:pAges[i][4].blu, label: pAges[i][0], no: pAges[i][4].num, per: perc};

  if (pAges[i][4].num != 0){
    perc = (pAges[i][4].red/pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNRed5[i] = {y:pAges[i][4].red, label: pAges[i][0], no: pAges[i][4].num, per: perc};

  if (pAges[i][4].num != 0){
    perc = (pAges[i][4].ora/pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNOrange5[i] = {y:pAges[i][4].ora, label: pAges[i][0], no: pAges[i][4].num, per: perc};
}

var chart5 = new CanvasJS.Chart("chartContainer5", {
//  theme: "light1",
colorSet: "Overview GYBRO",
title:{
  text: "Progress of Transitions in Age Classes"
},
  data: [
{
  type: "stackedColumn",
  toolTipContent: "<b>Uninfected:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNGreen5
},  {
  type: "stackedColumn",
  toolTipContent: "Incubating:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNYellow5
},  {
  type: "stackedColumn",
  toolTipContent: "Infectious:</b> {y}<br>{per}% of {no}}",
  dataPoints: ageNBlue5
},  {
  type: "stackedColumn",
  toolTipContent: "Diagnosed:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNRed5
},  {
  type: "stackedColumn",
  toolTipContent: "Isolated:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNOrange5
}
  ]
}
);
chart5.render();
pAges[ageCount][0] = "--"        // restore for conditionals in program



}



// **************************************************************************************
// START OF PROGRAM

var ageFlag = false;
var raceFlag = false;

var xSIZE = 800;
var ySIZE = 700;
var tRAVEL = [1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,5,6,6,6,6,6,10,10,10,30,30,50];
var dIRECTION = [-1,0,1];
var rand, randint;



// ***********************************************************************************

var contagion = true;

// ************************************************************************************


var U;                   // local Universes
var P = [];                   // all people in the system


function CreateUniverse() {
      this.uID;
      this.name;          // universe name
      this.Population;    // universe current population
      this.gen;
      this.Resident;    // these population numbers will change every hour perhaps
      this.Attached;
      this.Transient;
      this.minglX;
      this.greenCt;       // these counts reflect the status of this universe at this time
      this.yellowCt;
      this.newBlue;
      this.blueCt;
      this.redCt;
      this.orangeCt;
      this.canvas;
      this.person = [];
      this.avgIncDays;
      this.avgInfDays;
      this.avgClinDays;
      this.radius;
      this.logDay = [];
      this.logGreen = [];
      this.logYellow = [];
      this.logBlue = [];
      this.logRed = [];
      this.logOrange = [];
      this.endGreen = [];
      this.endYellow = [];
      this.endBlue = [];
      this.endRed = [];
      this.endOrange = [];
      this.endRedDelta = [];                // we need this to point to the persons there - just pIDs
      this.endVelocity = [];
      this.bHx = [];
      this.bConvHx = [];
}

function initUniv(U){
      U.uID = 0;
      U.name = "Single";
      U.Population = 20;
      U.gen = 0;
      U.Resident = 0;
      U.Attached = 0;
      U.Transient = 0;
      U.minglx = 2;
      U.greenCt = 20;
      U.yellowCt = 0;
      U.newBlue = 0;
      U.blueCt = U.newBlue;
      U.redCt = 0;
      U.orangeCt = 0;
      U.canvas = "";
      U.person = [];
      U.avgIncDays = 5;;
      U.avgInfDays = 7;
      U.avgClinDays = 1;
      U.radius = 10;
};


(function() {
    U = new CreateUniverse();
    initUniv(U);
})();

// DATA FOR AN entity

//
var cstate = "green";
var cclr = "green";
var cageGp = -1;
var csuscIndex = 1;
var cViralLoad = 0;
var cVExpression = 25;
var cVTransmission = 75;
var cincStart = 0;
var cincDays = U.avgIncDays;
var cincMax = 5;
var cinfectStart = 0;
var cinfectDays = 0;
var cinfectMax = U.avgInfDays;
var cinfectMode = 0;
var cinfectRate = 0.2;
var cdiagStart = 0;
var cdiagDays = 0;
var cdiagMax = 5;
var cinertStart = 0;
var cinertDays = 0;
var crole = "resident";
var cbaseSize = 10;
var ccurrSize = 10;
var cminglx = 3;
var cX = 0;
var cY = 0;

var radius = 5;

function CreatePerson() {       // the persistent info for a person
    this.pID;                   // issued in multiverse - most of this data generated in MULTIVERSE
    this.state;                 // uninfected; incubating; infectious; disagnosed; inert
    this.ageGp;
    this.suscIndx;
    this.ViralLoad;
    this.VExpression;
    this.VTransition;
    this.clr;
    this.incStart;              // date of infection and transition to incubating
    this.incDays;
    this.incMax;
    this.infectStart;           // date of transition to infectious
    this.infectDays;
    this.infectMax;
    this.infectMode;
    this.infectRate;
    this.diagStart;             // date of transition from asymtpomatic to diagnosed
    this.diagDays;
    this.diagMax;
    this.inertStart;            // date of transition to INERT
    this.inertDays;             // days since becoming inert

/* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                                LOCAL PERSON DATA STARTS here
   $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
*/
    this.role;
    this.baseSize;
    this.currSize;
    this.minglx;
    this.X;
    this.Y;
    this.OldX;
    this.OldY;
    this.newX;
    this.newY;
    this.delX;
    this.delY;
    this.ddx;
    this.ddy;
    this.bHx = [];
    this.bConvHx = [];
}

(function() {newPersons()})();

function newPersons(){
  for (i=0; i<U.Population; i++){
      P[i] = new CreatePerson;
      initPerson(P[i],i);
  }
}

function initPerson(P,i){
    P.pID = i;
    P.state = cstate;
    P.ageGp = -1;
    P.clr = cstate;
    P.suscIndex = csuscIndex;
    P.ViralLoad = cViralLoad;
    P.VExpression = Math.random()*(P.VExpression*0.1) + 0.9*P.VExpression;
    P.VTransition = Math.random()*(P.VTransition*0.1) + 0.9*P.VTransition;
    P.incStart = cincStart;
    P.incDays = cincDays;
    P.incMax = cincMax;
    P.infectStart = cinfectStart;
    P.infectDays = cinfectDays;
    P.infectMax = cinfectMax;
    P.infectMode = cinfectMode;
    P.infectRate = cinfectRate;
    P.diagStart  = cdiagStart;
    P.diagDays = cdiagDays;
    P.diagMax = cdiagMax;
    P.inertStart = cinertStart;
    P.inertDays = cinertDays;
    P.role = crole;
    P.baseSize = cbaseSize;
    P.currSize = ccurrSize;
    P.minglx = cminglx;
    P.X = cX;
    P.Y = cY;
    P.oldX = P.X;
    P.oldY = P.Y;
    P.newX = 0;
    P.newY = 0;
    P.delX = 0;
    P.delY = 0;
    P.ddx = 0;
    P.ddy = 0;
    P.bHx = [];
    P.bConvHx = [];
}

var drawMSEC = 1000;
var drawCycle = 400;
var FPS = 30;
var aniGoal = 5;          //count of click cycles
var myClick;

var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
ctx.fillStyle = "black";
ctx.fillRect(0,0,canvas.width, canvas.height);
ctx.globalCompositeOperation = "source-atop";


// *********************************************************************************
// THESE ARE INITIALIZATION AND UTILITY ROUTINES


window.onload = function(){
      CanvasJS.addColorSet("Overview GYBRO",
         [
         "#008000",
         "#FFD700",
         "#1E90FF",
         "#FF0000",
         "#FF8C00",
        ]);
}

var startme = true;
(function startUp(){
  if (startme){
    alert("START: input population and blues");
    }
    startme=false;
})();

  function loadPop(){
      var txt = prompt("Enter population - initial set to 100 \nBeware the canvas size is only 1200x800",U.Population);
      U.Population = parseInt(txt);
      document.getElementById("dPopn").innerHTML = U.Population;
      finishLoad();
  }

  function finishLoad(){
      ageFlag = false;
      raceFlag = false;
      resetArrays();
      setCountsToZero();
      allocate();             // position the agents and their fiedls
      showSettings();
      drawBalls(0);
      document.getElementById("csvButton").style.display="block";
  }

  function resetArrays(){
      P = [];
      newPersons();
  }

  function allocate(){
      if (U.Population > 10000) U.Population = 10000;
      for (let ct=0;ct<U.Population;ct++){
        P[ct].pID = ct;
        P[ct].X = Math.random()*(xSIZE*0.9)+(xSIZE*0.1);
        P[ct].Y = Math.random()*(ySIZE*0.9)+(ySIZE*0.1);
        P[ct].oldX = P[ct].X;
        P[ct].oldY = P[ct].Y;
        P[ct].infectDays = parseInt(Math.floor(Math.random()*U.avgInfDays/5*4+U.avgInfDays/5));
        P[ct].ageGp = -1;
      }
  }

function loadBlues(){
  var pBlue = prompt("Enter number of PERSONs to ADD as transmitters (BLUE):", U.newBlue);
  U.newBlue = parseInt(pBlue);
  document.getElementById("dCont").innerHTML = U.newBlue;
  execAddBlues(U.newBlue);
}

function execAddBlues(){
  addBlues(U.newBlue);
  showSettings();
  setCountsToZero();
  clearCanvas();
  drawBalls(0);
}

function addBlues(cut){
  var n, k;

  for (k=0;k<cut;k++){

    U.blueCt++;
    n = U.Population;
    P[n] = new CreatePerson();
    initPerson(P[n],n);
    if (ageFlag) {
      pAges[ageCount][4].num++;
      pAges[ageCount][4].blu++;
    }
    P[n].clr = "blue";
    P[n].state = "blue";
    P[n].infectDays = parseInt(Math.floor(Math.random()*U.avgInfDays/5*4+U.avgInfDays/5));
    P[n].infectMax = (Math.random()*U.avgInfDays/5*2)+U.avgInfDays/5*3;
    squeeze(n);       //squeese in a blue
    P[n].oldX = P[n].X;
    P[n].oldY = P[n].Y;
    U.Population++;
  }
}

function loadChart6(){
      chart6.options.data[0].dataPoints = [];
      chart6.options.data[0].dataPoints = endGreen6;
      chart6.options.data[1].dataPoints = [];
      chart6.options.data[1].dataPoints = endYellow6;
      chart6.options.data[2].dataPoints = [];
      chart6.options.data[2].dataPoints = endBlue6;;
      chart6.options.data[3].dataPoints = [];
      chart6.options.data[3].dataPoints = endRed6;
      chart6.options.data[4].dataPoints = [];
      chart6.options.data[4].dataPoints = endOrange6;
}



  function showSettings(){
      document.getElementById("dPopn").innerHTML = U.Population;
      document.getElementById("dCont").innerHTML = U.newBlue;
      document.getElementById("dGen").innerHTML = U.gen;
      document.getElementById("grCt").innerHTML = U.greenCt;
      document.getElementById("yeCt").innerHTML = U.yellowCt;
      document.getElementById("blCt").innerHTML = U.blueCt;
      document.getElementById("reCt").innerHTML = U.redCt;
      document.getElementById("orCt").innerHTML = U.orangeCt;
      document.getElementById("dDist").innerHTML = U.minglx;
      document.getElementById("dIncD").innerHTML = U.avgIncDays;
      document.getElementById("dInfD").innerHTML = U.avgInfDays;
      document.getElementById("dCliD").innerHTML = U.avgClinDays;
      document.getElementById("dPrad").innerHTML = U.radius;
      document.getElementById("ageSel").style.backgroundColor = "red";
  }

  function setCountsToZero(){
      U.gen=0;
      U.greenCt = U.Population - U.newBlue;
      U.yellowCt = 0;
      U.blueCt = U.newBlue;
      U.redCt = 0;
      U.orangeCt = 0;
      U.bHx = 0;              //this accumulates over all P
      U.bConvHx = 0;

      for (i=0; i<U.Population+1; i++){
          U.logDay[i] = 0;
          U.logGreen[i] = 0;
          U.logYellow[i] = 0;
          U.logBlue[i] = 0;
          U.logRed[i] = 0;
          U.logOrange[i] = 0;
      }

      if (ageFlag) initAgeTally();
}

function drawBalls(bClr){
  var i,j,k;
  clearCanvas();
  for (k=0; k<U.Population; k++){
    drawc(P[k].X,P[k].Y,P[k].baseSize,"black");
    if (bClr!=0){
      drawc(P[k].X,P[k].Y,P[k].currSize,"MidnightBlue")
    } else {
      drawc(P[k].X,P[k].Y,P[k].currSize,P[k].clr)
    }
  }
}


function finddelXY(i){
  randint = Math.floor(34*Math.random());
  if (P[i].clr=="blue" || P[i].clr=="red"){
      P[i].delX = (P[i].currSize*4) + P[i].minglx*tRAVEL[randint]
  } else {
      P[i].delX = (P[i].currSize/20 + P[i].minglx/20*tRAVEL[randint]);
  }
  randint = Math.floor(34*Math.random());
  if (P[i].clr=="blue" || P[i].clr=="red"){
      P[i].delY = (P[i].currSize*4) + P[i].minglx*tRAVEL[randint]
  } else {
      P[i].delY = (P[i].currSize/20 + P[i].minglx/20*tRAVEL[randint]);
  }
  randint = Math.floor(3*Math.random());            //'random direction
  //alert("X randint = "+randint);
  if (dIRECTION[randint]==-1){
      P[i].delX = -P[i].delX;
    } else {
      if (dIRECTION[randint]==0){
        P[i].delX=0;
      }
    }

  randint = Math.floor(3*Math.random());
  //  alert("Y randint = "+randint);
  if (dIRECTION[randint]==-1){
      P[i].delY = -P[i].delY;
    } else {
        if (dIRECTION[randint]==0){
            P[i].delY=0;
        }
    }
}

function drawc(x,y,rad,color){
  ctx.beginPath();
  ctx.arc(x,y,rad,0,2*Math.PI);
  ctx.fillStyle = color;
  ctx.fill();
  ctx.stroke();
  ctx.strokeStyle = "black";
}


function clearCanvas(){
  ctx.fillStyle = "black";
  ctx.fillRect(0,0,canvas.width, canvas.height);
}



function drawPop(){

for (i=0; i<U.Population; i++){
  drawc(P[i].oldX,P[i].oldY,P[i].currSize,"black");
  if(P[i].ddx<0){
    // are we at destination or beyond it
    if (P[i].oldX == P[i].X || P[i].oldX < P[i].X){
      P[i].ddx = 0
    }
  } else {
    if (P[i].oldX == P[i].X || P[i].oldX > P[i].X){
      P[i].ddx = 0
    }
  };
  P[i].oldX = P[i].oldX + P[i].ddx;
  if(P[i].ddy<0){
    if (P[i].oldY == P[i].Y || P[i].oldY < P[i].Y){
      P[i].ddy = 0
    }
  } else {
    if (P[i].oldY == P[i].Y || P[i].oldY > P[i].Y){
      P[i].ddy = 0
    }
  };
  P[i].oldY = P[i].oldY + P[i].ddy;
  drawc(P[i].oldX,P[i].oldY,P[i].currSize,P[i].clr);
  }
}

// **********************************************************************************
// THIS IS WHERE THINGS START BY DEFINING A POPULATION -
// BEWARE - THE DEFAULT MIGHT BE USED, SO THIS MAY NOT BE CALLED FOR STARTING Simulation





function shuffle(){
  var i,j,k,m,n;
  m = U.Population+2;
  for (j=0;j<3;j++){        //do this three times
    for (i=0;i<U.Population;i++){
      k = parseInt(1+Math.round(Math.random()*(U.Population)));
      P[m] = P[i];
      P[i] = P[k];
      P[k] = P[m];
    }
  }
}



function squeeze(n){
  P[n].X = parseInt(Math.floor(Math.random()*xSIZE/4*3));
  P[n].Y = parseInt(Math.floor(Math.random()*ySIZE/8*7));
}




// ****************************************************************************************
//
// THIS FUNCTION IS THE HEART OF THE SIMULATION - EACH CLICK IS A NEW PERIOD EG DAY

function showPop(){

    clearCanvas();
    goPop();    //takes a step and moves the entities
    tabulate();
    U.gen++;

    document.getElementById("dGen").innerHTML = U.gen;
    document.getElementById("grCt").innerHTML = U.greenCt;
    document.getElementById("yeCt").innerHTML = U.yellowCt;
    document.getElementById("blCt").innerHTML = U.blueCt;
    document.getElementById("reCt").innerHTML = U.redCt;
    document.getElementById("orCt").innerHTML = U.orangeCt;
}

// ****************************************************************************************
// THIS IS WHERE WE INITIATE THE MOVEMENTS
//
function goPop(){
  var i;
  proposeMove();                      //checks transitions
  drawThem();
  changeState();
}

function tabulate(){
  if (!startup) return;
      U.logDay[U.gen] = U.gen;
      U.logGreen[U.gen] = U.greenCt;
      U.logYellow[U.gen] = U.yellowCt;
      U.logBlue[U.gen] = U.blueCt;
      U.logRed[U.gen] = U.redCt;
      U.logOrange[U.gen] = U.orangeCt;

      upDateGraph6();
}

var realTimer;
var chart6;
var endGreen6 = [];
var endYellow6 = [];
var endBlue6 = [];
var endRed6 = [];
var endOrange6 = [];

function createChart6(){
  CanvasJS.addColorSet("Overview GYBRO",
     [
     "#008000",
     "#FFD700",
     "#1E90FF",
     "#FF0000",
     "#FF8C00",
    ]);

    chart6 = new CanvasJS.Chart("chartContainer6",{
    colorSet: "Overview GYBRO",
    title:{
      text: "Progress of Epidemic"
    },
    axisY: {
      title: "Total Susceptibles and Cases"
    },
    data: [{
    type: "line",
    markerType: "none",
    dataPoints: endGreen6

  },  {
    type: "line",
    markerType: "none",
    dataPoints: endYellow6
  },  {
    type: "line",
    markerType: "none",
    dataPoints: endBlue6
  },  {
    type: "line",
    markerType:"none",
    dataPoints: endRed6
  },  {
    type: "line",
    markerType: "none",
    dataPoints: endOrange6
    }
    ]
  }
);
}

(function() {createChart6();
             resetArrays()})();

function upDateGraph6(){
  endGreen6.push({y:U.logGreen[U.gen], x:U.gen});
  endYellow6.push({y:U.logYellow[U.gen],x:U.gen});
  endBlue6.push({y:U.logBlue[U.gen],x:U.gen});
  endRed6.push({y:U.logRed[U.gen],x:U.gen});
  endOrange6.push({y:U.logOrange[U.gen],x:U.gen});
  loadChart6();
  chart6.render();
}

  function proposeMove(){
      var i;
      for (i=0; i<U.Population; i++){
      //  clearCanvas;
        finddelXY(i);
        P[i].oldX = P[i].X;
        P[i].oldY = P[i].Y;
        //CHECK BOUNDARIES
        checkBounds(i);
        calcDeltas(i);
        P[i].X = P[i].newX;
        P[i].Y = P[i].newY;
        }
  }

function checkBounds(i){
  while (P[i].X + P[i].delX > xSIZE || P[i].X + P[i].delX<0){
    P[i].delX = -P[i].delX*0.5;
  };
  while (P[i].Y + P[i].delY > ySIZE || P[i].Y + P[i].delY <0){
    P[i].delY = -P[i].delY*0.5;
  }

  P[i].newX = P[i].X + P[i].delX;
  P[i].newY = P[i].Y + P[i].delY;

}

function calcDeltas(i){           //for animation
  P[i].ddx = Math.floor(parseInt(P[i].delX/drawCycle));
  if (P[i].ddx == 0) {
    if (P[i].delX<0){
      P[i].ddx = -1
    }
    else {
      P[i].ddx = 1;
    }
  }
  P[i].ddy = Math.floor(parseInt(P[i].delY/drawCycle));
  if (P[i].ddy == 0) {
    if (P[i].delY<0){
      P[i].ddy = -1}
    else {
      P[i].ddy = 1;
    }
  }
}

// ***********************************************************************************
// THIS IS WHERE WE CONSIDER EACH ENTITY AND WHAT HAPPENS TO ITS STATUS THIS CYCLE
//
function changeState(){
    if (contagion) {
      for (i=0;i<U.Population;i++){
          P[i].clr = P[i].state;
          testOverlap(P,i);
          testYellow(i);
          testBlue(i);
          testRed(i);
          collision(i);     // if contact, may change state
    }
  }
 }


var raDist;
var raMax;
 function testOverlap(P,i){
   let touchFlag = false;
   let j=0;
   for (j=0; j<U.Population; j++){
     if (i != j){
       xDelta = (P[i].X-P[j].X)**2;
       yDelta = (P[i].Y-P[j].Y)**2;
       yLength = Math.sqrt(xDelta+yDelta);
       raDist = parseInt(yLength);

       raMax = P[i].currSize+P[j].currSize
       if (raDist > raMax){
         touchFlag = false;
       } else {
         touchFlag = true;
       }
       if (touchFlag) VLtransfer(i,j);
     }
   }
 }

// focus on i's viral load - whether it will increase
 function VLtransfer(i,j){
     let iVL = P[i].ViralLoad;
     let jVL = P[j].ViralLoad;
     if (P[j].state == "green" || P[j].state=="orange") return;
     if (jVL <= iVL) return;

     let overlapF = (raDist/raMax)**2;
     let VLfactor = (jVL-iVL)/(jVL+iVL);
     let newVL = iVL + iVL*overlapF*VLfactor;
     P[i].ViralLoad = newVL;
 }

function testYellow(i){
  //*****************************************************
  // when Yellow turns Blue, the Max is stochastic range from current average infectious Days
  // the initial count is zero

  if (P[i].state!="yellow"){
    return;
  };

    P[i].incDays--;    //time to turn BLUE
    if (P[i].incDays==0 || P[i].incDays<0){
      P[i].state="blue";
      P[i].clr = "blue";
      //P[i].currSize=pOldSz[i];           //restore to original size
      U.blueCt++;
      U.yellowCt--;

      if(ageFlag){
        var ageR = P[i].ageGp;
        pAges[ageR][4].yel--;
        pAges[ageR][4].blu++;
      }
      P[i].infectMax = Math.floor((Math.random()*U.avgInfDays/3)+(2/3*U.avgInfDays));    //assume this will always be 1 or more
      P[i].infectDays = 0;           //will transmit today
      // code follows for infectivity - change pSize
    }
}

function testBlue(i){
  if (P[i].state=="blue"){
    reSizeBlue(i);
    P[i].infectDays++;

    if (P[i].infectDays > P[i].infectMax){
      //now we turn the blue to red
      P[i].state = "red";
      P[i].clr = "red";
      U.redCt++;
      U.blueCt--;

      if (ageFlag && P[i].ageGp == -1){
        pAges[ageCount][4].red++
        pAges[ageCount][4].blu--;
      } else {
        if (ageFlag && P[i].ageGp != -1) {
          pAges[P[i].ageGp][4].red++;
          pAges[P[i].ageGp][4].blu--;
        }
      }
      P[i].diagDays = 0;
      P[i].infectDays = 0;     //reset blue
      P[i].infectMax = U.avgInfDays;
   }
  }
}

function reSizeBlue(i){

  if (P[i].infectDays==P[i].infectMax || P[i].infectDays>P[i].infectMax){       //last day - don not grow
    return;
  }
}

function testRed(i){
  if (P[i].state=="red"){
    P[i].diagDays++;
    if (P[i].diagDays > U.avgClinDays){
      P[i].diagDays = 0;
      P[i].state = "orange";
      P[i].clr = "orange";
      U.orangeCt++;
      U.redCt--;

      if (ageFlag && P[i].ageGp == -1){
        pAges[ageCount][4].ora++
        pAges[ageCount][4].red--;
      } else {
        if (ageFlag && P[i].ageGp != -1) {
          pAges[P[i].ageGp][4].ora++;
          pAges[P[i].ageGp][4].red--;
        }
      }
      P[i].currSize = 6;
    }
  }
}




function collision(i){
  var j;
  for (j=0; j<U.Population; j++){
    if (i != j){
      xDelta = (P[i].X-P[j].X)**2;
      yDelta = (P[i].Y-P[j].Y)**2;
      yLength = Math.sqrt(xDelta+yDelta);
      raDist = parseInt(yLength);

      if (raDist > (P[i].currSize+P[j].currSize)){
        interBool = false;
      } else {
        interBool = true;
      }
      if (interBool) contactMade(i,j);
    }
  }
}

var greenPt, otherPt;

function contactMade(i,j){
  if (P[i].state == "blue" || P[i].state == "red") U.bHx[i]++;       // for R0 - but need to focus on i
  if (P[i].state == P[j].state){
    return
  } else {
    if (P[i].state=="blue" || P[i].state=="red"){
      modify(i,j);
    }
  }
}

function modify(i,j){
    if (P[j].state=="green") {
        greenPt=j;
        otherPt=i;
        P[i].bHx++;
        U.bHx++;
    } else {
        return;
    };
    P[otherPt].bConvHx++;     // for R0
    U.bConvHx++;
    P[greenPt].state = "yellow";
    P[greenPt].clr = "yellow";
    U.yellowCt++;
    U.greenCt--;

    if (ageFlag) {
      var ageR = P[greenPt].ageGp;
      pAges[ageR][4].gre--;
      pAges[ageR][4].yel++;
    }
    P[greenPt].incDays = Math.floor((Math.random()*U.avgIncDays/3)+(2/3*U.avgIncDays));
  }

function showDist(){
    var txt;
    var distTxt = prompt("Enter tRAVEL distance factor:", U.minglx);
    if (distTxt == null || distTxt == "") {
      txt = "-0";
    } else {
      txt = distTxt;
    }
    document.getElementById("dDist").innerHTML = txt;
    U.minglx = parseFloat(txt);
  }


function showIncD(){
  var incTxt = prompt("Enter number of days of incubation - for YELLOWs", U.avgIncDays);
  var incDays = parseFloat(incTxt);
  document.getElementById("dIncD").innerHTML = incDays;
  U.avgIncDays = incDays;
}


function showInfD(){
  var infTxt = prompt("Enter number of days of transmission - for BLUEs", U.avgInfDays);
  var infDays = parseFloat(infTxt);
  document.getElementById("dInfD").innerHTML = infDays;
  U.avgInfDays = infDays;
}


function showCliD(){
  var cliTxt = prompt("Detection is either becoming symptomatic or testing POSITIVE \nEnter # days of tranmission after clinical positive - for REDs", U.avgClinDays);
  var cliDays = parseFloat(cliTxt);
  document.getElementById("dCliD").innerHTML = cliDays;
  U.avgClinDays = cliDays;
}

function showPradius(){
  var i;
  var praTxt = prompt("Enter radius of personal safety \nThe smaller the extent of isolation", U.radius);
  var pRadi = parseFloat(praTxt);
  document.getElementById("dPrad").innerHTML = pRadi;
  U.radius = pRadi;

  for (i=0; i<U.Population; i++){
    if (P[i].state=="orange"){
      P[i].currSize=6;
    } else {
    pRatio = parseFloat(U.radius/P[i].baseSize);
    P[i].currSize=U.radius + pRatio;     //the new size plus a bit
    }
  };

  clearCanvas();
  for (i=0; i<U.Population; i++){
      drawc(P[i].X,P[i].Y,P[i].currSize,P[i].clr);
  }
 }

//*********** THE ANIMATION ROUTINES HERE  ******************************

function drawThem(){

  var i;
  for (i=1;i<drawCycle;i++){
      setTimeout(drawPop,drawMSEC/FPS);
  }
    drawBalls(1);
}


// **************************************************************************************
// THESE HAVE TO DO WITH AGE-BASED RISK AND IF WE DO IT, RACE-BASED RISK

// These are defaults in case you are lazy and don't want to enter a new Model
// The population %s are for BC
// The case %s are averaged from Spain and Italy (see wiki)
// Instead of entering a model by hand, best to save the list in a word <fieldset>
// then paste the appropriate list of values to set up the Model



var pAges = [];
pAges[0] = ["0 to 9",9.25,1,0, {}];
pAges[1] = ["10 to 19",10.29,2,0, {}];
pAges[2] = ["20 to 29",13.62,11,0];
pAges[3] = ["30 to 39",14.15,17,0];
pAges[4] = ["40 to 49",12.75,15,0];
pAges[5] = ["50 to 59",14.27,19,0];
pAges[6] = ["60 to 69",13.00,12,0];
pAges[7] = ["70 to 79",8.15,9,0];
pAges[8] = ["80 to 89",3.60,8,0];
pAges[9] = ["90+",0.92,5,0];
pAges[10] = ["--",0,0,0];

pAges[0][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[1][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[2][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[3][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[4][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[5][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[6][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[7][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[8][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[9][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
pAges[10][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}


var pRace = [];                 //0=name; 1=pop%; 2=case%; 3=risk
pRace[0] = ["---",0,0,0];
pRace[1] = ["---",0,0,0];
pRace[2] = ["---",0,0,0];
pRace[3] = ["---",0,0,0];
pRace[4] = ["---",0,0,0];
pRace[5] = ["---",0,0,0];
pRace[6] = ["---",0,0,0];
pRace[7] = ["---",0,0,0];
pRace[8] = ["---",0,0,0];

function initAgeTally(){
  var i;

  for (i=0;i<11;i++){
    pAges[i][4].num=0;
    pAges[i][4].gre=0;
    pAges[i][4].yel=0;
    pAges[i][4].blu=0;
    pAges[i][4].red=0;
    pAges[i][4].ora=0;
  }
}

function selAgeRisk(){
  ageFlag = true;
  document.getElementById("ageSel").style.backgroundColor = "lightgreen";


  document.getElementById("myTab").style.display="none";
  document.getElementById("AgeTab").style.display="block";
  initAgeTally();
  calcARisk();
  showAgeGp();
  // alert("In selAgeRisk, about to AssignAR()");
  assignAR();
  clearCanvas();
  proposeMove();
  drawThem();
}

function selRaceRisk(){
  raceFlag = true;
  document.getElementById("myTab").style.display="none";
  document.getElementById("RaceTab").style.display="block";
  showRNames();
}

function selModelMenu(){
  document.getElementById("AgeTab").style.display="none";
  document.getElementById("myTab").style.display="block";
  // alert("in selModeMenu just changing visibilities");
}

function retModelMenu(){
  document.getElementById("RaceTab").style.display="none";
  document.getElementById("myTab").style.display="block";
}


function ageGroup(){
  var x,y,z;
  var i;
  var ageStr = prompt("Enter ALL the age-group ranges (like '0-9') separated by ','");
  x = ageStr;
  if (x == "" || x == null) return;
  for (i=0;i<11;i++){
    pAges[1][0] = "--";      //clear the decks
  }
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    pAges[i][0] = (x.substring(0,y));
    x = x.substring(y+1);
  }
  pAges[i][0] = x.substring(0);
  ageCount = i;
  showAgeN();
}

function agePop(){
  var x,y,z;
  var i;
  var ageStr = prompt("Enter ALL the age-group population demographics % separated by ','");
  x = ageStr;
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    pAges[i][1] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  pAges[i][1] = x.substring(0);
  showAgeP();
}

function ageCase(){
  var x,y,z;
  var i;
  var ageStr = prompt("Enter all REFERENCE Covid CASE % by age-group, separated by ','");
  x = ageStr;
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    pAges[i][2] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  pAges[i][2] = x.substring(0);
  showAgeC();
  calcARisk();
}

function ageRisk(){
  var x,y,z;
  var i;
  var ageStr = prompt("Calculate the model risk for each age group");
/*
  x = ageStr;
  // alert(x);
  if (x!=-1 || !x){
      for (i=0; i<13; i++){
        y = x.indexOf(",",0);
        if (y== -1) break;
        pAges[i][3] = parseInt(x.substring(0,y));
        x = x.substring(y+1);
      };
      pAges[i][3] = x.substring(0);
  }
  */
  calcARisk();
}

function calcARisk(){
  var i,j,k,r;
  // we use the square root of the ratio between case% and age% (Relative Risk)
  // because the susceptibility we model as the area of the circle
  // describing the person, so the factor to apply is the square
  // root of the raw Relative Risk

  for (i=0; i<ageCount;i++){
    if (pAges[i][0] != "--") {
      j = pAges[i][2];      //case %
      k = pAges[i][1];      //popn %
      r = Math.sqrt(j/k).toFixed(2);
      pAges[i][3] = r;
    }
  }
  showAgeR();
}

function showAgeN(){
  document.getElementById("aG0").innerHTML = pAges[0][0];
  document.getElementById("aG1").innerHTML = pAges[1][0];
  document.getElementById("aG2").innerHTML = pAges[2][0];
  document.getElementById("aG3").innerHTML = pAges[3][0];
  document.getElementById("aG4").innerHTML = pAges[4][0];
  document.getElementById("aG5").innerHTML = pAges[5][0];
  document.getElementById("aG6").innerHTML = pAges[6][0];
  document.getElementById("aG7").innerHTML = pAges[7][0];
  document.getElementById("aG8").innerHTML = pAges[8][0];
  document.getElementById("aG9").innerHTML = pAges[9][0];
}

function showAgeP(){
  document.getElementById("ap0").innerHTML = pAges[0][1];
  document.getElementById("ap1").innerHTML = pAges[1][1];
  document.getElementById("ap2").innerHTML = pAges[2][1];
  document.getElementById("ap3").innerHTML = pAges[3][1];
  document.getElementById("ap4").innerHTML = pAges[4][1];
  document.getElementById("ap5").innerHTML = pAges[5][1];
  document.getElementById("ap6").innerHTML = pAges[6][1];
  document.getElementById("ap7").innerHTML = pAges[7][1];
  document.getElementById("ap8").innerHTML = pAges[8][1];
  document.getElementById("ap9").innerHTML = pAges[9][1];
}

function showAgeC(){
  document.getElementById("aC0").innerHTML = pAges[0][2];
  document.getElementById("aC1").innerHTML = pAges[1][2];
  document.getElementById("aC2").innerHTML = pAges[2][2];
  document.getElementById("aC3").innerHTML = pAges[3][2];
  document.getElementById("aC4").innerHTML = pAges[4][2];
  document.getElementById("aC5").innerHTML = pAges[5][2];
  document.getElementById("aC6").innerHTML = pAges[6][2];
  document.getElementById("aC7").innerHTML = pAges[7][2];
  document.getElementById("aC8").innerHTML = pAges[8][2];
  document.getElementById("aC9").innerHTML = pAges[9][2];
}

function showAgeR(){
  document.getElementById("aR0").innerHTML = pAges[0][3];
  document.getElementById("aR1").innerHTML = pAges[1][3];
  document.getElementById("aR2").innerHTML = pAges[2][3];
  document.getElementById("aR3").innerHTML = pAges[3][3];
  document.getElementById("aR4").innerHTML = pAges[4][3];
  document.getElementById("aR5").innerHTML = pAges[5][3];
  document.getElementById("aR6").innerHTML = pAges[6][3];
  document.getElementById("aR7").innerHTML = pAges[7][3];
  document.getElementById("aR8").innerHTML = pAges[8][3];
  document.getElementById("aR9").innerHTML = pAges[9][3];
}

function showAgeGp(){
  showAgeN();
  showAgeP();
  showAgeC();
  showAgeR();
}

function raceName(){
  var x,y,z;
  var i;
  var raceStr = prompt("Enter ALL the RACE or ETHNICITY names in a list, separated by commas");

  x = raceStr;
  // alert(x);
  for (i=0; i<11; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    pRace[i][0] = x.substring(0,y);
    x = x.substring(y+1);
  }
  pRace[i][0] = x.substring(0);
  showRNames();
}

function racePop(){
  var x,y,z;
  var i;
  var ageStr = prompt("Enter ALL the RACE or ETHNIC group population % separated by ','");
  x = ageStr;
  // alert(x);
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    pRace[i][1] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  pRace[i][1] = x.substring(0);
  showRPop();
}


function raceCase(){
  var x,y,z;
  var i;
  var ageStr = prompt("Enter all REFERENCE Covid CASE % by RACE or ETHNIC group, separated by ','");
  x = ageStr;
  // alert(x);
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    pRace[i][2] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  pRace[i][2] = x.substring(0);
  showRCase();
  calcRace();
  showRaceGp();
}

function raceRisk(){
  var x,y,z;
  var i;
  var raceStr = prompt("Calculate the model risk for each RACE or ETHNIC group","");
/*
  x = ageStr;
  // alert(x);
  if (x!=-1 || !x){
      for (i=0; i<13; i++){
        y = x.indexOf(",",0);
        if (y== -1) break;
        pAges[i][3] = parseInt(x.substring(0,y));
        x = x.substring(y+1);
      };
      pAges[i][3] = x.substring(0);
  }
  */
  calcRace();
  showRaceGp();
}

function calcRace(){
  var i,j,k,r;
  // we use the square root of the ratio between case% and age% (Relative Risk)
  // because the susceptibility we model as the area of the circle
  // describing the person, so the factor to apply is the square
  // root of the raw Relative Risk

  for (i=0; i<10;i++){
    j = pRace[i][2];      //case %
    k = pRace[i][1];      //popn %
    r = (j/k).toFixed(2);
    pRace[i][3] = r;
  }
}


function showRaceGp(){
  showRNames();
  showRPop();
  showRCase();
  document.getElementById("rR0").innerHTML = pRace[0][3];
  document.getElementById("rR1").innerHTML = pRace[1][3];
  document.getElementById("rR2").innerHTML = pRace[2][3];
  document.getElementById("rR3").innerHTML = pRace[3][3];
  document.getElementById("rR4").innerHTML = pRace[4][3];
  document.getElementById("rR5").innerHTML = pRace[5][3];
  document.getElementById("rR6").innerHTML = pRace[6][3];
  document.getElementById("rR7").innerHTML = pRace[7][3];
  document.getElementById("rR8").innerHTML = pRace[8][3];
}

function showRNames(){

    document.getElementById("rN0").innerHTML = pRace[0][0];
    document.getElementById("rN1").innerHTML = pRace[1][0];
    document.getElementById("rN2").innerHTML = pRace[2][0];
    document.getElementById("rN3").innerHTML = pRace[3][0];
    document.getElementById("rN4").innerHTML = pRace[4][0];
    document.getElementById("rN5").innerHTML = pRace[5][0];
    document.getElementById("rN6").innerHTML = pRace[6][0];
    document.getElementById("rN7").innerHTML = pRace[7][0];
    document.getElementById("rN8").innerHTML = pRace[8][0];
}

function showRPop(){
    document.getElementById("rP0").innerHTML = pRace[0][1];
    document.getElementById("rP1").innerHTML = pRace[1][1];
    document.getElementById("rP2").innerHTML = pRace[2][1];
    document.getElementById("rP3").innerHTML = pRace[3][1];
    document.getElementById("rP4").innerHTML = pRace[4][1];
    document.getElementById("rP5").innerHTML = pRace[5][1];
    document.getElementById("rP6").innerHTML = pRace[6][1];
    document.getElementById("rP7").innerHTML = pRace[7][1];
    document.getElementById("rP8").innerHTML = pRace[8][1];
}

function showRCase(){
    document.getElementById("rC0").innerHTML = pRace[0][2];
    document.getElementById("rC1").innerHTML = pRace[1][2];
    document.getElementById("rC2").innerHTML = pRace[2][2];
    document.getElementById("rC3").innerHTML = pRace[3][2];
    document.getElementById("rC4").innerHTML = pRace[4][2];
    document.getElementById("rC5").innerHTML = pRace[5][2];
    document.getElementById("rC6").innerHTML = pRace[6][2];
    document.getElementById("rC7").innerHTML = pRace[7][2];
    document.getElementById("rC8").innerHTML = pRace[8][2];
}

// ****************************************************************************************
// THESE ROUTINES SET UP POPULATION TO ACCOUNT FOR RISKS AND WILL CALL ON SIZE CHANGES
var ageCount = 10;

function assignAR(){
//  // alert("in assignAR");
  var i,j,k
  var popLo, popNum, popHi, popAccum = 0;

  for (var i=0;i<11;i++){
    if (pAges[i][0]=="--"){
      break;
    }
  }
//  // alert("i and ageCount "+i);
  ageCount = i;

  popLo = 0;
  popHi  = 0;
  popAccum = 0;
  for (i=0; i<ageCount; i++){
    popLo = popHi;
    popNum = parseInt(Math.round(pAges[i][1]*U.Population/100));
    if (pAges[i+1][0]=="--"){
      popNum = U.Population - popAccum;      //round out population so everyone is in a group
    }
    popHi = popLo + popNum;
    for (j=popLo; j<popHi; j++){
      P[j].ageGp = i;
    }
    popAccum = popAccum + popNum;
  }
  applyAgeRisk();
//  shuffle();
  drawThem();
}

function applyAgeRisk(){
  var i,j;

  for (i=0; i<U.Population; i++){
    j = P[i].ageGp;

    //we are keeping the pfSusc[i] as 1 for now, reserving it for some
    //future purpose; we modify p[i] using AgeRisk table itself

    P[i].currSize = P[i].currSize*pAges[j][3];

    // now we enter the data structure for keeping track of state
    pAges[j][4].num++;
    if (P[i].clr == "blue") {
      pAges[j][4].blu++
    } else {
      pAges[j][4].gre++;
    }
  }
}

// $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//                        read csv files
// %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

//handleFiles("data.csv");
var lines = [];
var csvFlag = true;

function startCSV(){
    if (csvFlag) {
        document.getElementById("csvButton").innerHTML = "CANCEL CSV";
        csvFlag = false;
        document.getElementById("csvGet").style.display = "block";
    } else {
        csvFlag = true;
        document.getElementById("csvButton").innerHTML = "CSV file";
        document.getElementById("csvGet").style.display = "none";
        document.getElementById("csvButton").style.display = "none";
    }
}


function handleFiles(files) {
	// Check for the various File API support.
	if (window.FileReader) {
		// FileReader are supported.
		getAsText(files[0]);
	} else {
		alert('FileReader are not supported in this browser.');
	}
}

function getAsText(fileToRead) {
	var reader = new FileReader();
	// Handle errors load
	reader.onload = loadHandler;
	reader.onerror = errorHandler;
	// Read file into memory as UTF-8
	reader.readAsText(fileToRead);
}

function loadHandler(event) {
	var csv = event.target.result;
	processData(csv);
}

function processData(csv) {
    var allTextLines = csv.split(/\r\n|\n/);
    while (allTextLines.length) {
        lines.push(allTextLines.shift().split(','));
    }
	processLines();
//	drawOutput(lines);
}

function errorHandler(evt) {
    	if(evt.target.error.name == "NotReadableError") {
    		alert("Canno't read file !");
      }
}

// &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
//
function processLines(){
    let i,j;
    if (lines[0][0] == "pID") lines.shift();
    var lineNo = lines.length;
    for (i=0;i<lineNo;i++){
      if (parseL(lines[i]))
          setupPerson();
    }
    document.getElementById("csvGet").style.display="none";
}

function parseL(lineStr){
  let lineS = lineStr;
  if (lineS == "") return false;
  let ID = eval(lineS[0]);
  transfer.pID = ID;
  transfer.stopno = eval(lineS[1]);
  transfer.ETA = eval(lineS[2]);
  transfer.AU = eval(lineS[3]);
  transfer.ETD = eval(lineS[4]);
  transfer.TU = eval(lineS[5]);
  transfer.role = lineS[6];
  transfer.Mx = eval(lineS[7]);
  if  (lineS[8] == "" || lineS[8]===undefined){
    return true;
  } else {
    P[ID].age = eval(lineS[8]);
    return true;
  }
}

// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


</script>

</head>
<body>
<div id="chartContainer1" style="height: 370px; width: 45%; display: inline-block;"></div>
<div id="chartContainer2" style="height: 370px; width: 45%%;display: inline-block;"></div><br>
<div id="chartContainer3" style="height: 370px; width: 45%; display: inline-block;"></div>
<div id="chartContainer4" style="height: 370px; width: 45%%; display: inline-block;"></div><br>
<div id="chartContainer5" style="height: 370px; width: 45%%; display: inline-block;"></div>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

</body>
</html>
