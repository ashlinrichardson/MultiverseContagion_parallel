U[ui].ageCount<!DOCTYPE html>
<html>
<style>
  th,  td {
    border: 1px solid red;
    padding: 3px;
    text-align: center;
}
  th {
      cursor: pointer;
  }

#myTab {
    display: block;
  }

#AgeTab {
    display: none;
  }

#RaceTab {
    display: none;
  }

</style>
<p>CovidSim Stochastic Cellular Automata April 2020 @EC_GO - PUBLIC DOMAIN as per GNU GPL LICENSING</p>
<body>


  <div class="topnav">
    <table ID="myTab">
      <tr>
        <th onclick="loadPop()">Population RESET</th>
        <th onclick="loadBlues()" bgcolor=LightBlue>Add Blues</th>
        <th id ="popClick" onclick="showPop()" bgcolor=lightgreen>Click Me</th>
        <th>Greens</th>
        <th>Yellows</th>
        <th>Blues</th>
        <th>Reds</th>
        <th onclick="showDist()">TRAVEL</th>
        <th onclick="showIncD()">Incubation days</th>
        <th onclick="showInfD()" bgcolor=LightBlue>Infectious Days</th>
        <th onclick="showInfM()" bgcolor=LightBlue>Infection Mode</th>
        <th onclick="showInfR()" bgcolor=LightBlue>InfGrowth Rate</th>
        <th onclick="showCliD()">RED days</th>
        <th onclick="showPradius()">Hazard Radius</th>
        <th id=popClick onclick="showAnimate()">Animation</th>
        <th onclick="endChart()">Show Chart</th>
        <th id="ageSel" onclick="selAgeRisk()" bgcolor=red style="cursor:pointer">Age Group Risk</th>
      </tr>
      <tr>
        <td id="dPopn"></td>
        <td id="dCont"></td>
        <td id="dGen">0</td>
        <td id="grCt">1</td>
        <td id="yeCt">0</td>
        <td id="blCt">0</td>
        <td id="reCt">0</td>
        <td id="dDist">7</td>
        <td id="dIncD">2</td>
        <td id="dInfD">5</td>
        <td id="dInfM">3</td>
        <td id="dInfR">1.1</td>
        <td id="dCliD">1</td>
        <td id="dPrad">20</td>
        <td id="dAnim">5</td>
        <td onclick="setTuring()" bgcolor=blue style="cursor:pointer; color:white">set Turing</td>
        <td onclick="selRaceRisk()" bgcolor=red style="cursor:pointer">Race Based Risk</td>
      </tr>
    </table>
    <table id="AgeTab">
      <tr>
        <th onclick="ageGroup()" style="cursor:pointer">AGE GROUP</th>
        <th onclick="agePop()" style="cursor:pointer">% Population</th>
        <th onclick="ageCase()" style="cursor:pointer">% Cases</th>
        <th onclick="ageRisk()" style="cursor:pointer">Model Risk</th>
        <th onclick="selModelMenu()" bgcolor=lightgreen >RETURN</th>
      </tr>

      <tr>
        <td id="aG0">0 to 9</td>
        <td id="ap0" ></td>
        <td id="aC0" ></td>
        <td id="aR0" ></td>
      </tr>
      <tr>
        <td id="aG1" >10 to 19</td>
        <td id="ap1" ></td>
        <td id="aC1" ></td>
        <td id="aR1" ></td>
      </tr>
      <tr>
        <td id="aG2" >20 to 29</td>
        <td id="ap2" ></td>
        <td id="aC2" ></td>
        <td id="aR2" ></td>
      </tr>
      <tr>
        <td id="aG3" >32 to 39</td>
        <td id="ap3" ></td>
        <td id="aC3" ></td>
        <td id="aR3" ></td>
      </tr>
      <tr>
        <td id="aG4">40 to 49</td>
        <td id="ap4" ></td>
        <td id="aC4" ></td>
        <td id="aR4" ></td>
      </tr>
      <tr>
        <td id="aG5">50 to 59</td>
        <td id="ap5" ></td>
        <td id="aC5" ></td>
        <td id="aR5" ></td>
      </tr>
      <tr>
        <td id="aG6">65 to 69</td>
        <td id="ap6" ></td>
        <td id="aC6" ></td>
        <td id="aR6" ></td>
      </tr>
      <tr>
        <td id="aG7">70 to 79</td>
        <td id="ap7" ></td>
        <td id="aC7" ></td>
        <td id="aR7" ></td>
      </tr>
      <tr>
        <td id="aG8">87 to 89</td>
        <td id="ap8" ></td>
        <td id="aC8" ></td>
        <td id="aR8" ></td>
      </tr>
      <tr>
        <td id="aG9">90+</td>
        <td id="ap9" ></td>
        <td id="aC9" ></td>
        <td id="aR9" ></td>
      </tr>
      <tr>
        <td id="aG10">--</td>
        <td id="ap10" >--</td>
        <td id="aC10" >--</td>
        <td id="aR10" >--</td>


    </table>
    <table id="RaceTab">
      <tr>
        <th onclick="raceName()" style="cursor:pointer">RACE or Ethnicity</th>
        <th onclick="racePop()" style="cursor:pointer">% of Popn</th>
        <th onclick="raceCase()" style="cursor:pointer">% of Cases</th>
        <th onclick="raceRisk()" style="cursor:pointer">Model Risk</th>
        <th onclick="retModelMenu()" bgcolor=DarkSeaGreen >RETURN</th>
      </tr>

      <tr>
        <td id="rN0"></td>
        <td id="rP0"></td>
        <td id="rC0"></td>
        <td id="rR0"></td>
      </tr>
      <tr>
        <td id="rN1"></td>
        <td id="rP1"></td>
        <td id="rC1"></td>
        <td id="rR1"></td>
      </tr>
      <tr>
        <td id="rN2"></td>
        <td id="rP2"></td>
        <td id="rC2"></td>
        <td id="rR2"></td>
      </tr>
      <tr>
        <td id="rN3"></td>
        <td id="rP3"></td>
        <td id="rC3"></td>
        <td id="rR3"></td>
      </tr>
      <tr>
        <td id="rN4"></td>
        <td id="rP4"></td>
        <td id="rC4"></td>
        <td id="rR4"></td>
      </tr>
      <tr>
        <td id="rN5"></td>
        <td id="rP5"></td>
        <td id="rC5"></td>
        <td id="rR5"></td>
      </tr>
      <tr>
        <td id="rN6"></td>
        <td id="rP6"></td>
        <td id="rC6"></td>
        <td id="rR6"></td>
      </tr>
      <tr>
        <td id="rN7"></td>
        <td id="rP7"></td>
        <td id="rC7"></td>
        <td id="rR7"></td>
      </tr>
      <tr>
        <td id="rN8"></td>
        <td id="rP8"></td>
        <td id="rC8"></td>
        <td id="rR8"></td>
      </tr>

    </table>
  </div>



  <canvas id="myCanvas" width="2000" height="1000"
          style="border:1px solid #d3d3d3;">
  </canvas>

  <div id="chartContainer1" style="height: 370px; width: 45%; display: inline-block;"></div>
  <div id="chartContainer2" style="height: 370px; width: 45%%;display: inline-block;"></div><br>
  <div id="chartContainer3" style="height: 370px; width: 45%; display: inline-block;"></div>
  <div id="chartContainer4" style="height: 370px; width: 45%%; display: inline-block;"></div><br>
  <div id="chartContainer5" style="height: 370px; width: 45%%; display: inline-block;"></div>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script>

// *********************************************************************************************************
// *********************************************************************************************************
//
//       STRUCTURE IS:        VARIABLES LOCAL NOT NEEDING CHKPT FIRST, WITH THEIR ROUTINES
//                            FOR LOCAL DISPLAY
//
//                            CHART DISPLAY ROUTINES
//                            ACTION FIELD DISPLAY ROUTINES
//
//       PARAMETERS NEEDING CHECKPOINT AND RESTORE, AND OTHER GLOBAL VARIABLES
//
//                           THE PARAMETER SETTING ROUTINES
//                           THE SIMULATION CORE ROUTINES
//
//                            these are what needs to run on DATA FOR VIRTUAL UNIVERSES
//
// **********************************************************************************************************
// **********************************************************************************************************
// Here are the data structures a UNIVERSE
//
//                            UNIVERSE CHARACTERISTICS
//

function Universe (){

    this.ageFlag = false;
    this.raceFlag = false;
    this.turingFlag = false;
    this.contagion = true;

    this.xSIZE = 1400;
    this.ySIZE = 800;
    this.tRAVEL = [1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,5,6,6,6,6,6,10,10,10,30,30,50];
    this.dIRECTION = [-1,0,1];

    this.Population = 4;        //1600
    this.gen = 0;                    // a critical counter for time intervals
    this.greenCt;
    this.yellowCt;
    this.blueCt;
    this.redCt = 0;
    this.orangeCt = 0;



// ************************* AGENT SETTINGS FOR THIS UNIVERSE AT THIS TIME ***********************

    this.radius = 20;        //20
    this.newBlue = 0;
    this.avgSus = 1;
    this.fDist = 40;
    this.avgIncDays = 7;     //2
    this.avgInfDays = 5;
    this.infectMode = 0;     //3
    this.avgInfRate = 1.1;   //this is a compunding rate
    this.avgClinDays = 1;

// **************************   AGENT i MODEL   *********************************

    this.pID = [];
    this.pX = [];
    this.pY = [];
    this.pSize = [];           //radius = initial size; changes with infectivity & susceptibility
    this.pOldSz = [];

    this.pColor = [];          //green = susc; yellow=incub; blue=transmitter; red=cliniical; purple=recovered
    this.pStatus = [];         //same as color but color may be used for vector display
    this.pfInfectMode = [];    // 0 = constant; 1=increase with days by 25%; 2=superspreader at 5x radius
    this.pfInfectRate = [];
    this.pIncDay = [];         //number of incubation days
    this.pTransCount = [];     //days of transmit count
    this.pTransMax = [];       //no. of transmitting days
    this.pClinCount = [];      //count of clinical days
    this.pxAgeGp = [];         // age-gp of the entity
    this.pfSusc = [];          //starts at 1

    this.newX = [];
    this.newY = [];
    this.delX = [];
    this.delY = [];

    this.OldX = [];
    this.OldY = [];
    this.ddx = [];
    this.ddy = [];


// *************************** WORKING BARIABLES FOR AGENTS FOR THIS UNIVERSE ***********************

    this.logDay = [];
    this.logGreen = [];
    this.logYellow = [];
    this.logBlue = [];
    this.logRed = [];
    this.logOrange = [];
    this.logPop = [];
    this.logTravel = [];
    this.logIncubate = [];
    this.logInfectD = [];
    this.logInfectM = [];
    this.logInfGrow = [];
    this.logRedD = [];
    this.logPsize = [];

// ****************************************** Age and other Risk Tables for this UNIVERSE **********************

    this.ageCount = 10;
    this.pAges = [];
    this.pRace = [];

// ****************************************** Turing Tape Control Mechanism **************************
//
    this.tur = [];

}

function CreateTuring(){                // constructor for instances of Turing tapes
  this.start;
  this.blues;
  this.travel;
  this.incubate;
  this.infect;
  this.mode;
  this.factor;
  this.hazard;
}


// ****************************************************************************************************
// ****************************************************************************************************
//
//                              THIS UNIVERSE HAS A LOT OF INITIAL SET-UP FOR PARAMETERS
//
//                              THESE ARE THE SETUP ROUTINES
//
// ****************************************************************************************************

function loadPop(){
  var txt = prompt("Enter population - initial set to 100 \nBeware the canvas size is only 1200x800",U[ui].Population);
  U[ui].Population = parseInt(txt);
  document.getElementById("dPopn").innerHTML = U[ui].Population;

  dTable();                     // initialize the menu table with the defaults for this universe
  U[ui].newBlue = 0;
  calcRowCol();                 // initiatlizes the Field of action for the population
  drawBalls(0);                 // we will condense the visualization rotuines later
}

function dTable(){
    document.getElementById("dPopn").innerHTML = U[ui].Population;
    document.getElementById("dCont").innerHTML = U[ui].newBlue;
    document.getElementById("dGen").innerHTML = 0;
    document.getElementById("grCt").innerHTML = 0;
    document.getElementById("yeCt").innerHTML = 0;
    document.getElementById("blCt").innerHTML = 0;
    document.getElementById("reCt").innerHTML = 0;
    document.getElementById("dDist").innerHTML = U[ui].fDist;
    document.getElementById("dIncD").innerHTML = U[ui].avgIncDays;
    document.getElementById("dInfD").innerHTML = U[ui].avgInfDays;
    document.getElementById("dInfM").innerHTML = U[ui].infectMode;
    document.getElementById("dInfR").innerHTML = U[ui].avgInfRate;
    document.getElementById("dCliD").innerHTML = U[ui].avgClinDays;
    document.getElementById("dPrad").innerHTML = U[ui].radius;
    document.getElementById("dAnim").innerHTML = aniGoal;
}

// STILL PART OF LOADING POPULATION - CALCULATE ROWS AND COLUMNS AND SEPAARATION BETWEEN THEM

function calcRowCol(){
    var pRow, pCol, pMaxRadius;
    var pShape, pSep;
    pRow = parseInt(Math.sqrt(U[ui].Population));

    //assume minimum radius of 3 with separation of 6 - one more than diameter
    //each entity needs 6 (diam) + 3 + 3 = 12
    //if floor (900/12 > pRow) we can fit into a square
    //otherwise if (1200/12 > pRow) we can't fit them at all
    //max is (1200/12) in rows and (900/12 in columns
    //and we have to start at (3,3) for first entity
    //so max rectangle is 100 x 70 = 7,000 entities
    //max square array is 70x70 = 4900 ENTITIES

    //so if population is less than 4900 we can create square
    //otherwise we have to create a rectangle

    //to optimize H & L such that H and L are close we fit <thead>
    //rows first - ie 70 rows then use as many columns as needed, which is
    //(population/70) columns

    //if the square array is nxn, then the space needed is 1200/(n+1)
    //which is 2 diameters, so the radius is 300/(n+1)

    pShape = "RECT";
    if (U[ui].Population > 7000){
      U[ui].Population = 7000;        //that's the maximum
    } else {
      if (U[ui].Population < 4900){
        pCol = pRow;
        pShape = "SQ";
      }
    }
    if (pShape=="RECT"){
      pRow = 70;
      pCol = parseInt(U[ui].Population/pRow);
    }
    pSep = parseInt(U[ui].ySIZE/pRow);
    pMaxRadius = parseInt(pSep/4);
    if (pMaxRadius < U[ui].radius){
        U[ui].radius = pMaxRadius;
        document.getElementById("dPrad").innerHTML = U[ui].radius;
    };
    pMaxRadius = parseInt(U[ui].xSIZE/pRow);      //separation between columns
    if (pMaxRadius < U[ui].radius) {
      U[ui].radius = pMaxRadius;
    };
    pInit(pRow,pCol,pSep);
  }

// STILL PART OF LOADING POPULATIO - NOW WE INITIALIZE THE AGENT LOCATIONS

function pInit(pRow,pCol,pSep){
  var i;
  document.getElementById("ageSel").style.backgroundColor = "red";  // ? WHY HERE
  clearCanvas();                                                    // OR THIS ?
  U[ui].ageFlag = false;
  U[ui].raceFlag = false;
  initTallies();          // BECAUSE EVERY TIME LOAD IS CALLED, WE RESET ALL AGENTS

  for (y=1; y<(pRow+1); y++){
    for (x=1; x<(pCol+1); x++){
      i = ((y-1)*pCol) + x;
      U[ui].pID[i] = i;                  //unique identifier may need
      U[ui].pX[i] = (x-1)*pSep+(2*U[ui].radius);
      U[ui].pY[i] = (y-1)*pSep+(2*U[ui].radius);
      U[ui].OldX[i] = U[ui].pX[i];
      U[ui].OldY[i] = U[ui].pY[i];
      U[ui].pOldSz[i] = U[ui].radius;
      U[ui].pColor[i] = "gray";

      // SUSCEPTIBILITY DISTRIBUTION GOES HERE

      U[ui].pfSusc[i] = 1;

      //
      U[ui].pSize[i] = U[ui].radius * U[ui].pfSusc[i];
      U[ui].pfInfectMode[i] = U[ui].infectMode;
      U[ui].pfInfectRate[i] = U[ui].avgInfRate;
      U[ui].pStatus[i] = "green";
    }
  }
  shuffle();
  // draw population initial

  document.getElementById("grCt").innerHTML = U[ui].greenCt;
  document.getElementById("yeCt").innerHTML = U[ui].yellowCt;
  document.getElementById("blCt").innerHTML = U[ui].blueCt;
}

// STILL PART OF LOAD POPULATION - NEED TO RESET FOR NEW POPULATION

function initTallies(){
  var i;
  U[ui].gen=0;
  U[ui].greenCt = U[ui].Population;
  U[ui].yellowCt = 0;
  U[ui].blueCt = 0;
  U[ui].redCt = 0;
  U[ui].orangeCt = 0;
  document.getElementById("dGen").innerHTML = U[ui].gen;
  document.getElementById("grCt").innerHTML = U[ui].greenCt;
  document.getElementById("yeCt").innerHTML = U[ui].yellowCt;
  document.getElementById("blCt").innerHTML = U[ui].blueCt;
  document.getElementById("reCt").innerHTML = U[ui].redCt;

  for (i=0; i<U[ui].Population+1; i++){
    U[ui].logDay[i] = 0;
    U[ui].logGreen[i] = 0;
    U[ui].logYellow[i] = 0;
    U[ui].logBlue[i] = 0;
    U[ui].logRed[i] = 0;
    U[ui].logOrange[i] = 0;
    U[ui].logPop[i] = 0;
    U[ui].logTravel[i] = 0;
    U[ui].logIncubate[i] = 0;
    U[ui].logInfectD[i] = 0;
    U[ui].logInfGrow[i] = 0;
    U[ui].logRedD[i] = 0;
    U[ui].logPsize[i] = 0;
  }
  if (U[ui].ageFlag) initAgeTally();
}

// STILL PART OF LOAD POPULATION - IF THE AGE RISK WAS USED WE NEED TO CLEANSE IT FOR THE NEW POPULATION

function initAgeTally(){
  var i;
  for (i=0;i<11;i++){
    U[ui].pAges[i][4].num=0;
    U[ui].pAges[i][4].gre=0;
    U[ui].pAges[i][4].yel=0;
    U[ui].pAges[i][4].blu=0;
    U[ui].pAges[i][4].red=0;
    U[ui].pAges[i][4].ora=0;
  }
}

// STILL BUT AT END OF LOAD POPULATION - WANT TO SHUFFLE THE AGENTS IN THEIR LOCATIONS
// THIS ROUTINE IS A UTILITY WHICH WILL BE CALLED FROM ELSEWHERE

function shuffle(){
  var i,j,k,m,n;
  m = U[ui].Population+2;

  for (j=1;j<4;j++){        //do this three times
    for (i=1;i<U[ui].Population+1;i++){
      k = parseInt(1+Math.round(Math.random()*(U[ui].Population-1)));
      U[ui].pSize[m] = U[ui].pSize[i];
      U[ui].pColor[m] = U[ui].pColor[i];
      U[ui].pStatus[m] = U[ui].pStatus[i];
      U[ui].pfInfectMode[m] = U[ui].pfInfectMode[i];
      U[ui].pfInfectRate[m] = U[ui].pfInfectRate[i];
      U[ui].pIncDay[m] = U[ui].pIncDay[i];
      U[ui].pTransCount[m] = U[ui].pTransCount[i];
      U[ui].pTransMax[m] = U[ui].pTransMax[i];
      U[ui].pClinCount[m] = U[ui].pClinCount[i];
      U[ui].pxAgeGp[m] = U[ui].pxAgeGp[i];
      U[ui].pfSusc[m] = U[ui].pfSusc[i];
      U[ui].newX[m] = U[ui].newX[i];
      U[ui].newY[m] = U[ui].newY[i];
      U[ui].delX[m] = U[ui].delX[i];
      U[ui].delY[m] = U[ui].delY[i];
      U[ui].OldX[m] = U[ui].OldX[i];
      U[ui].OldY[m] = U[ui].OldY[i];
      U[ui].ddx[m] = U[ui].ddx[i];
      U[ui].ddy[m] = U[ui].ddy[i];


      U[ui].pSize[i] = U[ui].pSize[k];
      U[ui].pColor[i] = U[ui].pColor[k];
      U[ui].pStatus[i] = U[ui].pStatus[k];
      U[ui].pfInfectMode[i] = U[ui].pfInfectMode[k];
      U[ui].pfInfectRate[i] = U[ui].pfInfectRate[k];
      U[ui].pIncDay[i] = U[ui].pIncDay[k];
      U[ui].pTransCount[i] = U[ui].pTransCount[k];
      U[ui].pTransMax[i] = U[ui].pTransMax[k];
      U[ui].pClinCount[i] = U[ui].pClinCount[k];
      U[ui].pxAgeGp[i] = U[ui].pxAgeGp[k];
      U[ui].pfSusc[i] = U[ui].pfSusc[k];
      U[ui].newX[i] = U[ui].newX[k];
      U[ui].newY[i] = U[ui].newY[k];
      U[ui].delX[i] = U[ui].delX[k];
      U[ui].delY[i] = U[ui].delY[k];
      U[ui].OldX[i] = U[ui].OldX[k];
      U[ui].OldY[i] = U[ui].OldY[k];
      U[ui].ddx[i] = U[ui].ddx[k];
      U[ui].ddy[i] = U[ui].ddy[k];


      U[ui].pSize[k] = U[ui].pSize[m];
      U[ui].pColor[k] = U[ui].pColor[m];
      U[ui].pStatus[k] = U[ui].pStatus[m];
      U[ui].pfInfectMode[k] = U[ui].pfInfectMode[m];
      U[ui].pfInfectRate[k] = U[ui].pfInfectRate[m];
      U[ui].pIncDay[k] = U[ui].pIncDay[m];
      U[ui].pTransCount[k] = U[ui].pTransCount[m];
      U[ui].pTransMax[k] = U[ui].pTransMax[m];
      U[ui].pClinCount[k] = U[ui].pClinCount[m];
      U[ui].pxAgeGp[k] = U[ui].pxAgeGp[m];
      U[ui].pfSusc[k] = U[ui].pfSusc[m];
      U[ui].newX[k] = U[ui].newX[m];
      U[ui].newY[k] = U[ui].newY[m];
      U[ui].delX[k] = U[ui].delX[m];
      U[ui].delY[k] = U[ui].delY[m];
      U[ui].OldX[k] = U[ui].OldX[m];
      U[ui].OldY[k] = U[ui].OldY[m];
      U[ui].ddx[k] = U[ui].ddx[m];
      U[ui].ddy[k] = U[ui].ddy[m];
    }
  }
}

// *************************************************************************************************
// ****************** FINISHED THE FIRST BUTTON IN SETUP - NOW THE LOAD BLUES BUTTON ***************
//
//                    THIS IS STILL SETTING UP THIS UNIVERSE AND ITS POPULATION AND PARAMETER ******
//                    NOW WE INJECT BLUES (INFECTED) AND WE NEED THEM TO START CONTAGION
//
//                    IF WE ADD THEM AFTER WE DISTRIBUTE THE POPULATION BY DEMOGRAPHICS THEN
//                    THEY ARE COUNTED AS VISITORS
//
// **************************************************************************************************

function loadBlues(){
  var pBlue = prompt("Enter number of PERSONs to ADD as transmitters (BLUE):", U[ui].newBlue);
  U[ui].newBlue = parseInt(pBlue);
  document.getElementById("dCont").innerHTML = U[ui].newBlue;
  addBlues(U[ui].newBlue);
  drawBalls(0);
  U[ui].newBlue = 0;
  document.getElementById("dCont").innerHTML = U[ui].newBlue;
  shuffle();
  drawBalls(0);
}

function addBlues(cut){
  // These are "external" BLUES and not part of the age-Risk POPULATION
  // but of course they are infective! They form the sees of the contagion
  // they have an infective period which is stochastic

  // The stachastic nature of these are randmomized from count of days already infective
  // while the maximum is determinate at  avgMax
  alert("In addBlues with # = "+cut);
  var n, k;
  for (k=1;k<cut+1;k++){            // FOR EACH NEW BLUE THAT WE ARE ADDING
    U[ui].Population++;
    n = U[ui].Population;
    U[ui].blueCt++;
    if (U[ui].ageFlag) {                  // WE HAVE ALREADY APPLIED DEMOGRAPHICS TO POPULATION
      U[ui].pAges[U[ui].ageCount][4].num++;     // THEY GO INTO THE "other" CATEGORY
      U[ui].pAges[U[ui].ageCount][4].blu++;
    }
    U[ui].pID[n] = n;                     // CREATE ALL THE CHARACTERISTICS OF THE AGENT
    U[ui].pSize[n] = U[ui].radius;
    alert("in addblue,k, cut, radius "+k+","+cut+","+U[ui].radius);
    U[ui].pOldSz[n] = U[ui].pSize[n];
    U[ui].pColor[n] = "blue";
    U[ui].pStatus[n] = "blue";
    U[ui].pfInfectMode[n] = U[ui].infectMode;
    U[ui].pfInfectRate[n] = U[ui].avgInfRate;
    U[ui].pIncDay[n] = U[ui].avgIncDays;
    U[ui].pTransCount[n] = parseInt(Math.floor(Math.random()*U[ui].avgInfDays/5*4+U[ui].avgInfDays/5));
    U[ui].pTransMax[n] = U[ui].avgInfDays;
    U[ui].pClinCount[n] = 0;
    U[ui].pxAgeGp[n] = -1;
    U[ui].pfSusc[n] = 1;
    U[ui].newX[n] = 0;
    U[ui].newY[n] = 0;
    U[ui].delX[n] = 0;
    U[ui].delY[n] = 0;
    U[ui].OldX[n] = 0;
    U[ui].OldY[n] = 0;
    U[ui].ddx[n] = 0;
    U[ui].ddy[n] = 0;
    squeeze(n);                      //squeese in a blue - GIVE IT (X,y) POSITION
    U[ui].OldX[n] = U[ui].pX[n];
    U[ui].OldY[n] = U[ui].pY[n];
  }
  document.getElementById("blCt").innerHTML = U[ui].blueCt;
}

function squeeze(n){                // PUT THEM ANYWHERE IN FIRST QUADRANT
  U[ui].pX[n] = parseInt(Math.floor(Math.random()*U[ui].xSIZE/2));
  U[ui].pY[n] = parseInt(Math.floor(Math.random()*U[ui].ySIZE/2));
  if (U[ui].avgInfRate == 99) alert("n,pX,U[ui].pY = "+n+","+U[ui].pX[n]+","+U[ui].pY[n]);
}

// ********************************************************************************************
//
// ************************** NOW WE INITIALIZE THE REST OF THE MENU IF DESIRED ****************

function showDist(){
    var txt;
    var distTxt = prompt("Enter tRAVEL distance factor:", U[ui].fDist);
    if (distTxt == null || distTxt == "") {
      txt = "-0";
    } else {
      txt = distTxt;
    }
    document.getElementById("dDist").innerHTML = txt;
    U[ui].fDist = parseFloat(txt);
  }

function showIncD(){
  var incTxt = prompt("Enter number of days of incubation - for YELLOWs", U[ui].avgIncDays);
  var incDays = parseInt(incTxt);
  document.getElementById("dIncD").innerHTML = incDays;
  U[ui].avgIncDays = incDays;
}

function showInfD(){
  var infTxt = prompt("Enter number of days of transmission - for BLUEs", U[ui].newBlue);
  var infDays = parseInt(infTxt);
  document.getElementById("dInfD").innerHTML = infDays;
  U[ui].avgInfDays = infDays;
}

function showInfM(){
  var infTxt = prompt("Mode of Transmission \n  0 = Constant \n  1 = 2x in infectious period \n  2 = 3x in period \n  3 = compound rate", U[ui].avgInfRate);
  var infMode = parseInt(infTxt);
  if ((infMode>3)||(infMode<1)){
    infMode=0;
  }
  document.getElementById("dInfM").innerHTML = infMode;
  U[ui].infectMode = infMode;

  if (U[ui].infectMode==3){         //not needed for Turing
    showInfR();
  };
  exeInfMode();
}

function exeInfMode() {
  if (U[ui].infectMode == 2) {
      U[ui].avgInfRate = parseFloat(2/U[ui].avgInfDays);
  };
  if (U[ui].infectMode==1){
      U[ui].avgInfRate = parseFloat(1/U[ui].avgInfDays);
  };
  var inf;
  for (inf=1; inf<U[ui].Population+1; inf++){
    U[ui].pfInfectMode[inf] = U[ui].infectMode;
    U[ui].pfInfectRate[inf] = U[ui].avgInfRate;
  }
}

function showInfR(){
  var infTxt = prompt("Enter multiplier per day growth rate - for BLUEs \n     Example 1.2 is 20% day over day growth", U[ui].avgInfRate);
  var infRate = parseFloat(infTxt);
  document.getElementById("dInfR").innerHTML = infRate;
  U[ui].avgInfRate = infRate;
  exeInfR();
}

function exeInfR() {
  var inf;
  for (inf=1; inf<U[ui].Population+1; inf++){
    U[ui].pfInfectMode[inf] = U[ui].infectMode;
    U[ui].pfInfectRate[inf] = U[ui].avgInfRate;
  }
}

function showCliD(){
  var cliTxt = prompt("Detection is either becoming symptomatic or testing POSITIVE \nEnter # days of tranmission after clinical positive - for REDs", U[ui].avgClinDays);
  var cliDays = parseInt(cliTxt);
  document.getElementById("dCliD").innerHTML = cliDays;
  U[ui].avgClinDays = cliDays;
}

function showPradius(){
  var i;
  var praTxt = prompt("Enter radius of personal safety \nThe smaller the extent of isolation", U[ui].radius);
  var pRadi = parseInt(praTxt);
  document.getElementById("dPrad").innerHTML = pRadi;
  U[ui].radius = pRadi;
  exeRadius(i);
}

function exeRadius(i) {
  for (i=1; i<U[ui].Population+1; i++){
    if (U[ui].pStatus[i]=="orange"){
      U[ui].pSize[i]=6;
    } else {
    pRatio = parseFloat(U[ui].radius/U[ui].pOldSz[i]);
    alert(pRatio+" "+U[ui].radius+" "+U[ui].pSize[i]);
    U[ui].pSize[i]=parseInt(U[ui].radius) + pRatio;     //the new size plus a bit
    alert("pSize in exeRadius "+U[ui].pSize[i]);
    }
  };
  clearCanvas();
  for (i=1; i<U[ui].Population+1; i++){
      drawc(U[ui].pX[i],U[ui].pY[i],U[ui].pSize[i],U[ui].pColor[i]);
  }
}




  // **************************************************************************************
  // THESE INITIALIZE THE UNIVERSE WITH ITS AGE-BASED RISK AND ANOTHER RISK TABLE

  // These are defaults in case you are lazy and don't want to enter a new Model
  // The population %s are for BC
  // The case %s are averaged from Spain and Italy (see wiki)
  // Instead of entering a model by hand, best to save the list in a word <fieldset>
  // then paste the appropriate list of values to set up the Model

function selAgeRisk(){
    U[ui].ageFlag = true;
    document.getElementById("ageSel").style.backgroundColor = "lightgreen";
    document.getElementById("myTab").style.display="none";
    document.getElementById("AgeTab").style.display="block";
    initAgeTally();
    calcARisk();
    showAgeGp();
    assignAR();       // GIVE THE RISK TO EVERY POPULATION AGENT
    clearCanvas();
    popUpdate();
    drawThem();
  }

function calcARisk() {
    var i,j,k,r;
    // we use the square root of the ratio between case% and age% (Relative Risk)
    // because the susceptibility we model as the area of the circle
    // describing the person, so the factor to apply is the square
    // root of the raw Relative Risk


    for (i=0; i<U[ui].ageCount;i++){
      if (U[ui].pAges[i][0] != "--") {
        j = U[ui].pAges[i][2];      //case %
        k = U[ui].pAges[i][1];      //popn %
        r = Math.sqrt(j/k).toFixed(2);
        U[ui].pAges[i][3] = r;
      }
    }
    showAgeR();
  }


function showAgeGp(){
    showAgeN();
    showAgeP();
    showAgeC();
    showAgeR();
  }

function assignAR(){
    var i,j,k
    var popLo, popNum, popHi, popAccum = 0;
    for (i=0;i<12;i++){
      if (U[ui].pAges[i][0]=="--"){
        break;
      }
    }
    U[ui].ageCount = i;           // WE MAY NOT HAVE A FULL TABLE
    popLo = 0;
    popHi  = 0;
    popAccum = 0;
    for (i=0; i<U[ui].ageCount; i++){
      popLo = popHi + 1;
      popNum = parseInt(Math.round(U[ui].pAges[i][1]*U[ui].Population/100));
      if (U[ui].pAges[i+1][0]=="--"){
        popNum = U[ui].Population - popAccum;      //round out population so everyone is in a group
      }
      popHi = popLo + popNum - 1;
      for (j=popLo; j<popHi+1; j++){
        U[ui].pxAgeGp[j] = i;
      }
      popAccum = popAccum + popNum;
    }
    applyAgeRisk();
    shuffle();
    changeP();
    clearCanvas();
    drawThem();
  //  drawBalls(0);
}

  // STILL IN SETUP AGE-RISK - NOW TALLYING NUMBER OF AGEMTS OM EACJ AGE GROUP
  // AT THE START THERE ARE NO YELLOWS OR REDS

function applyAgeRisk(){
    var i,j;
    for (i=1; i<(U[ui].Population+1); i++){
      j = U[ui].pxAgeGp[i];
      //we are keeping the U[ui].pfSusc[i] as 1 for now, reserving it for some
      //future purpose; we modify p[i] using AgeRisk table itself
      U[ui].pSize[i] = U[ui].pSize[i]*U[ui].pAges[j][3];    //RISK FACTOR AFFECT SIZE

      // now we enter the data structure for keeping track of state
      U[ui].pAges[j][4].num++;
      if (U[ui].pColor[i] == "blue") {
        U[ui].pAges[j][4].blu++
      } else {
        U[ui].pAges[j][4].gre++;
      }
    }
  }

function showAgeN(){
    document.getElementById("aG0").innerHTML = U[ui].pAges[0][0];
    document.getElementById("aG1").innerHTML = U[ui].pAges[1][0];
    document.getElementById("aG2").innerHTML = U[ui].pAges[2][0];
    document.getElementById("aG3").innerHTML = U[ui].pAges[3][0];
    document.getElementById("aG4").innerHTML = U[ui].pAges[4][0];
    document.getElementById("aG5").innerHTML = U[ui].pAges[5][0];
    document.getElementById("aG6").innerHTML = U[ui].pAges[6][0];
    document.getElementById("aG7").innerHTML = U[ui].pAges[7][0];
    document.getElementById("aG8").innerHTML = U[ui].pAges[8][0];
    document.getElementById("aG9").innerHTML = U[ui].pAges[9][0];
  }

function showAgeP(){
    document.getElementById("ap0").innerHTML = U[ui].pAges[0][1];
    document.getElementById("ap1").innerHTML = U[ui].pAges[1][1];
    document.getElementById("ap2").innerHTML = U[ui].pAges[2][1];
    document.getElementById("ap3").innerHTML = U[ui].pAges[3][1];
    document.getElementById("ap4").innerHTML = U[ui].pAges[4][1];
    document.getElementById("ap5").innerHTML = U[ui].pAges[5][1];
    document.getElementById("ap6").innerHTML = U[ui].pAges[6][1];
    document.getElementById("ap7").innerHTML = U[ui].pAges[7][1];
    document.getElementById("ap8").innerHTML = U[ui].pAges[8][1];
    document.getElementById("ap9").innerHTML = U[ui].pAges[9][1];
  }

function showAgeC(){
    document.getElementById("aC0").innerHTML = U[ui].pAges[0][2];
    document.getElementById("aC1").innerHTML = U[ui].pAges[3][2];
    document.getElementById("aC2").innerHTML = U[ui].pAges[2][2];
    document.getElementById("aC3").innerHTML = U[ui].pAges[3][2];
    document.getElementById("aC4").innerHTML = U[ui].pAges[4][2];
    document.getElementById("aC5").innerHTML = U[ui].pAges[5][2];
    document.getElementById("aC6").innerHTML = U[ui].pAges[6][2];
    document.getElementById("aC7").innerHTML = U[ui].pAges[7][2];
    document.getElementById("aC8").innerHTML = U[ui].pAges[8][2];
    document.getElementById("aC9").innerHTML = U[ui].pAges[9][2];
  }

function showAgeR(){
    document.getElementById("aR0").innerHTML = U[ui].pAges[0][3];
    document.getElementById("aR1").innerHTML = U[ui].pAges[1][3];
    document.getElementById("aR2").innerHTML = U[ui].pAges[2][3];
    document.getElementById("aR3").innerHTML = U[ui].pAges[3][3];
    document.getElementById("aR4").innerHTML = U[ui].pAges[4][3];
    document.getElementById("aR5").innerHTML = U[ui].pAges[5][3];
    document.getElementById("aR6").innerHTML = U[ui].pAges[6][3];
    document.getElementById("aR7").innerHTML = U[ui].pAges[7][3];
    document.getElementById("aR8").innerHTML = U[ui].pAges[8][3];
    document.getElementById("aR9").innerHTML = U[ui].pAges[9][3];
  }

// *******************************************************************************************
//            WE CAN SELECT THE DEMOGRAPHIC AND CASE DISTRIBUTION TO CUSTOMIZE THEM **********

function ageGroup(){          // THIS CUSTOMIZES THE NAME OF THE GROUPS
  var x;
  var ageStr = prompt("Enter ALL the age-group ranges (like '0-9') separated by ','");
  x = ageStr;
  parseAgeGp(x);
}

function parseAgeGp(x){
  var i,y,z;
  if (x == "" || x == null) return;
  for (i=0;i<11;i++){
    U[ui].pAges[1][0] = "--";      //clear the decks
  }
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    U[ui].pAges[i][0] = (x.substring(0,y));
    x = x.substring(y+1);
  }
  U[ui].pAges[i][0] = x.substring(0);
  U[ui].ageCount = i;
  showAgeN();
}

function agePop(){          // THIS CUSTOMIZEZ DEMOGRAPHICS
  var x,y,z;
  var i;
  var ageStr = prompt("Enter ALL the age-group population demographics % separated by ','");
  x = ageStr;
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    U[ui].pAges[i][1] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  U[ui].pAges[i][1] = x.substring(0);
  showAgeP();
}

function ageCase(){
  var x,y,z;                // RHIS CUSTOMIZES CASE DISTRIBUTION BY AGE GROUP
  var i;
  var ageStr = prompt("Enter all REFERENCE Covid CASE % by age-group, separated by ','");
  x = ageStr;
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    U[ui].pAges[i][2] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  U[ui].pAges[i][2] = x.substring(0);
  showAgeC();
  calcARisk();
}

function ageRisk(){
  var x,y,z;
  var i;
  var ageStr = prompt("ENTER CUSTOM model risk for each age group");
  x = ageStr;
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    U[ui].pAges[i][3] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  U[ui].pAges[i][3] = x.substring(0);
  showAgeR();
}

function selModelMenu(){                // ALLOWS US TO RETURN TO MAIN MENU
  document.getElementById("AgeTab").style.display="none";
  document.getElementById("myTab").style.display="block";
  // alert("in selModeMenu just changing visibilities");
}

// **************************************************************************************************
//
//                    STILL INITIALIZING THIS UNIVERSE - NOW WITH THE OTHER RISK TABLE
//
// **************************************************************************************************

function selRaceRisk(){
  U[ui].raceFlag = true;
  document.getElementById("myTab").style.display="none";
  document.getElementById("RaceTab").style.display="block";
  showRNames();
}

function raceName(){
  var x,y,z;
  var i;
  var raceStr = prompt("Enter ALL the RISK CATEGORY names in a list, separated by commas");

  x = raceStr;
  // alert(x);
  for (i=0; i<11; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    U[ui].pRace[i][0] = x.substring(0,y);
    x = x.substring(y+1);
  }
  U[ui].pRace[i][0] = x.substring(0);
  showRNames();
}

function showRNames(){
    document.getElementById("rN0").innerHTML = U[ui].pRace[0][0];
    document.getElementById("rN1").innerHTML = U[ui].pRace[1][0];
    document.getElementById("rN2").innerHTML = U[ui].pRace[2][0];
    document.getElementById("rN3").innerHTML = U[ui].pRace[3][0];
    document.getElementById("rN4").innerHTML = U[ui].pRace[4][0];
    document.getElementById("rN5").innerHTML = U[ui].pRace[5][0];
    document.getElementById("rN6").innerHTML = U[ui].pRace[6][0];
    document.getElementById("rN7").innerHTML = U[ui].pRace[7][0];
    document.getElementById("rN8").innerHTML = U[ui].pRace[8][0];
}

function racePop(){           // ENTER DEMOGRAPHIC DISTRIBUTION OF THE RISK FACTORS
  var x,y,z;
  var i;
  var ageStr = prompt("Enter ALL the RACE or ETHNIC group population % separated by ','");
  x = ageStr;
  // alert(x);
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    U[ui].pRace[i][1] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  U[ui].pRace[i][1] = x.substring(0);
  showRPop();
}

function showRPop(){
    document.getElementById("rP0").innerHTML = U[ui].pRace[0][1];
    document.getElementById("rP1").innerHTML = U[ui].pRace[1][1];
    document.getElementById("rP2").innerHTML = U[ui].pRace[2][1];
    document.getElementById("rP3").innerHTML = U[ui].pRace[3][1];
    document.getElementById("rP4").innerHTML = U[ui].pRace[4][1];
    document.getElementById("rP5").innerHTML = U[ui].pRace[5][1];
    document.getElementById("rP6").innerHTML = U[ui].pRace[6][1];
    document.getElementById("rP7").innerHTML = U[ui].pRace[7][1];
    document.getElementById("rP8").innerHTML = U[ui].pRace[8][1];
}

function raceCase(){
  var x,y,z;
  var i;
  var ageStr = prompt("Enter all REFERENCE Covid CASE % by RISK FACTOR, separated by ','");
  x = ageStr;
  // alert(x);
  for (i=0; i<13; i++){
    y = x.indexOf(",",0);
    if (y== -1) break;
    U[ui].pRace[i][2] = parseInt(x.substring(0,y));
    x = x.substring(y+1);
  }
  U[ui].pRace[i][2] = x.substring(0);
  showRCase();
  calcRace();
  showRaceGp();
}

function showRCase(){
    document.getElementById("rC0").innerHTML = U[ui].pRace[0][2];
    document.getElementById("rC1").innerHTML = U[ui].pRace[1][2];
    document.getElementById("rC2").innerHTML = U[ui].pRace[2][2];
    document.getElementById("rC3").innerHTML = U[ui].pRace[3][2];
    document.getElementById("rC4").innerHTML = U[ui].pRace[4][2];
    document.getElementById("rC5").innerHTML = U[ui].pRace[5][2];
    document.getElementById("rC6").innerHTML = U[ui].pRace[6][2];
    document.getElementById("rC7").innerHTML = U[ui].pRace[7][2];
    document.getElementById("rC8").innerHTML = U[ui].pRace[8][2];
}

function calcRace(){
  var i,j,k,r;
  // we use the square root of the ratio between case% and age% (Relative Risk)
  // because the susceptibility we model as the area of the circle
  // describing the person, so the factor to apply is the square
  // root of the raw Relative Risk

  for (i=0; i<10;i++){
    j = U[ui].pRace[i][2];      //case %
    k = U[ui].pRace[i][1];      //popn %
    r = (j/k).toFixed(2);
    U[ui].pRace[i][3] = r;
  }
}

function raceRisk(){
  var x,y,z;
  var i;
  var raceStr = prompt("ENTER THE CUSTOM Model Risk for each rsik factor","");

  x = ageStr;

  if (x!=-1 || !x){
      for (i=0; i<13; i++){
        y = x.indexOf(",",0);
        if (y== -1) break;
        U[ui].pAges[i][3] = parseInt(x.substring(0,y));
        x = x.substring(y+1);
      };
      U[ui].pAges[i][3] = x.substring(0);
  }
  showRaceGp();
}


function showRaceGp(){
  showRNames();
  showRPop();
  showRCase();
  document.getElementById("rR0").innerHTML = U[ui].pRace[0][3];
  document.getElementById("rR1").innerHTML = U[ui].pRace[1][3];
  document.getElementById("rR2").innerHTML = U[ui].pRace[2][3];
  document.getElementById("rR3").innerHTML = U[ui].pRace[3][3];
  document.getElementById("rR4").innerHTML = U[ui].pRace[4][3];
  document.getElementById("rR5").innerHTML = U[ui].pRace[5][3];
  document.getElementById("rR6").innerHTML = U[ui].pRace[6][3];
  document.getElementById("rR7").innerHTML = U[ui].pRace[7][3];
  document.getElementById("rR8").innerHTML = U[ui].pRace[8][3];
}

function retModelMenu(){              // returns to main menu
  document.getElementById("RaceTab").style.display="none";
  document.getElementById("myTab").style.display="block";
}

// **********************************************************************************************
//
//              FINISH THE SETUP - NOW WE HAVE OTHER UTILITY AND VISUALIZATIONS
//
// ************************************************************************************************
//
//              FIRST THE DATA STRUCTURES
//
var drawMSEC = 1000;
var drawCycle = 400;
var FPS = 30;
var aniGoal = 5;          //count of click cycles
var myClick;

var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
ctx.fillStyle = "black";
ctx.fillRect(0,0,canvas.width, canvas.height);
ctx.globalCompositeOperation = "source-atop";

function initAgeTabs(ui) {
    U[ui].pAges[0] = ["0 to 9",9.25,0.55,0, {}];
    U[ui].pAges[1] = ["10 to 19",10.29,0.65,0, {}];
    U[ui].pAges[2] = ["20 to 29",13.62,5.20,0];
    U[ui].pAges[3] = ["30 to 39",14.15,8.95,0];
    U[ui].pAges[4] = ["40 to 49",12.75,14.30,0];
    U[ui].pAges[5] = ["50 to 59",14.27,19.5,0];
    U[ui].pAges[6] = ["60 to 69",13.00,15.95,0];
    U[ui].pAges[7] = ["70 to 79",8.15,15.5,0];
    U[ui].pAges[8] = ["80 to 89",3.60,14.25,0];
    U[ui].pAges[9] = ["90+",0.92,5.05,0];
    U[ui].pAges[10] = ["--",0,0,0];

    U[ui].pAges[0][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[1][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[2][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[3][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[4][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[5][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[6][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[7][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[8][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[9][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
    U[ui].pAges[10][4] = {"num":0, "gre":0, "yel":0, "blu":0, "red":0, "ora":0}
}


function initRaceTabs(ui) {
    U[ui].pRace[0] = ["---",0,0,0];
    U[ui].pRace[1] = ["---",0,0,0];
    U[ui].pRace[2] = ["---",0,0,0];
    U[ui].pRace[3] = ["---",0,0,0];
    U[ui].pRace[4] = ["---",0,0,0];
    U[ui].pRace[5] = ["---",0,0,0];
    U[ui].pRace[6] = ["---",0,0,0];
    U[ui].pRace[7] = ["---",0,0,0];
    U[ui].pRace[8] = ["---",0,0,0];
}

function clearCanvas(){
  ctx.fillStyle = "black";
  ctx.fillRect(0,0,canvas.width, canvas.height);
}

function drawc(x,y,rad,color){
  ctx.beginPath();
  ctx.arc(x,y,rad,0,2*Math.PI);
  ctx.fillStyle = color;
  ctx.fill();
  ctx.stroke();
  ctx.strokeStyle = "black";
}

function drawBalls(bClr){
  var i,j,k;
  if (U[ui].avgInfRate == 99) alert("In drawBalls");
  for (k=1; k<U[ui].Population+1; k++){
    if (bClr!=0){
      drawc(U[ui].pX[k],U[ui].pY[k],U[ui].pSize[k],"MidnightBlue")
    } else {
      drawc(U[ui].pX[k],U[ui].pY[k],U[ui].pOldSz[k],"black");
      drawc(U[ui].pX[k],U[ui].pY[k],U[ui].pSize[k],U[ui].pColor[k])
    }
  }
}

function drawThem(){
  if (U[ui].avgInfRate == 99) alert("In drawThem");
  var i;
  for (i=1;i<drawCycle;i++){
      setTimeout(drawPop,drawMSEC/FPS);
  }
    drawBalls(1);
}

function showAnimate(){
  var aniTxt = prompt("Number of animation cycles (mouseclick days) before a pause \n To continue with existing value press [ENTER] \n You can reset paramters here for interventions",aniGoal);
  if (aniTxt == null || aniTxt == "" || aniTxt=="0"){
    aniTxt = 0;
    clearInterval(myClick);
    aniGoal = 0;
  };
  aniGoal = parseInt(aniTxt);
  document.getElementById("dAnim").innerHTML = aniTxt;
  clearInterval(myClick);
  aniCt= 0;
  if (aniGoal!=0){
    myClick = setTimeout(clickButton,5);
  }
}

function clickButton(){
      aniCt++;
      document.querySelector("#popClick").click();
      if (aniCt == aniGoal) {
        clearInterval(myClick)
      } else
      clickButton;
}

function drawPop(){
  if (U[ui].avgInfRate == 99) alert("In drawPop");
for (i=1; i<U[ui].Population+1; i++){
  drawc(U[ui].OldX[i],U[ui].OldY[i],U[ui].pSize[i],"black");
  if(U[ui].ddx[i]<0){
    // are we at destination or beyond it
    if (U[ui].OldX[i] == U[ui].pX[i] || U[ui].OldX[i] < U[ui].pX[i]){
      U[ui].ddx[i] = 0
    }
  } else {
    if (U[ui].OldX[i] == U[ui].pX[i] || U[ui].OldX[i] > U[ui].pX[i]){
      U[ui].ddx[i] = 0
    }
  };
  U[ui].OldX[i] = U[ui].OldX[i] + U[ui].ddx[i];
  if(U[ui].ddy[i]<0){
    if (U[ui].OldY[i] == U[ui].pY[i] || U[ui].OldY[i] < U[ui].pY[i]){
      U[ui].ddy[i] = 0
    }
  } else {
    if (U[ui].OldY[i] == U[ui].pY[i] || U[ui].OldY[i] > U[ui].pY[i]){
      U[ui].ddy[i] = 0
    }
  };
  U[ui].OldY[i] = U[ui].OldY[i] + U[ui].ddy[i];
  drawc(U[ui].OldX[i],U[ui].OldY[i],U[ui].pSize[i],U[ui].pColor[i]);
  }
}

// ******************************************************************************************************
//
//                        CODE FOR THE CHARTS THAT CAN BE SEEN ANYTIME
//
// ******************************************************************************************************

function endChart(){
  var i;
  var endRedData = new Array(U[ui].gen+1);
    U[ui].logRed[0] = 0;
    for (i=0; i<U[ui].gen+1; i++){
      endRedData[i] = {y: U[ui].logRed[i], label: i};
    }

  var chart1 = new CanvasJS.Chart("chartContainer1", {
      	animationEnabled: true,
      	theme: "light2", // "light1", "light2", "dark1", "dark2"
      	title:{
      		text: "TOTAL Cases to Date"
  	},
  	axisY: {
  		title: "Number of Clinical or Positive"
  	},
    width:500,
  	data: [{
  		type: "column",
  		showInLegend: true,
  		legendMarkerColor: "grey",
  		legendText: "Days since beginning",
  		dataPoints: endRedData
  	}]
  });
  chart1.render();

// chart 2 **********************************************
  var del1, del2;
  var endRedDelta = new Array(U[ui].gen+1);
  U[ui].logRed[0] = 0;
  endRedDelta[0] = {y:0, label:0};

  for (i=1; i<U[ui].gen+1; i++){
    del1 = U[ui].logRed[i];
    del2 = U[ui].logRed[i-1];
    del1 = del1-del2;
//    // alert("i+del1+del2 "+i+","+U[ui].logRed[i]+","+U[ui].logRed[i-1]);
//    // alert("del1 = "+del1);
    endRedDelta[i] = {y: del1, label: i};
  }

  var chart2 = new CanvasJS.Chart("chartContainer2", {
    animationEnabled: true,
    theme: "light2", // "light1", "light2", "dark1", "dark2"
    title:{
      text: "Daily NEW Cases"
    },
    axisY: {
      title: "Number of Clinical or Positive"
    },
    width:500,
    data: [{
      type: "column",
      showInLegend: true,
      legendMarkerColor: "grey",
      legendText: "Days since beginning",
      dataPoints: endRedDelta
  }]
  });
  chart2.render();


// CHART3 **********************************************************

  var endVelocity = new Array(U[ui].gen+1);
  var endV, vNum, vDenom;

  endVelocity[0] = {y:0, label:0};

  for (i=1; i<U[ui].gen+1; i++){
      vNum = endRedDelta[i].y;
      vDenom = endRedData[i-1].y;
      if (vDenom!=0){
        endV = parseFloat((vNum/vDenom)*100);
      }
        else {
          endV = 0
        };
      endVelocity[i] = {y: endV, label: i};
  }


  var chart3 = new CanvasJS.Chart("chartContainer3", {
  animationEnabled: true,
  zoomEnabled: true,
  theme: "light2", // "light1", "light2", "dark1", "dark2"
  title:{
    text: "Percent Increase over Previous TOTAL"
  },
  axisY: {
    title: "Percent Increase"
  },
  width:500,
  data: [{
    type: "line",
    showInLegend: true,
    legendMarkerColor: "grey",
    legendText: "Days since beginning",
    dataPoints: endVelocity
  }]
  });
  chart3.render();


// *********************************************************************************
// CHART 4 - GREEN YELLOE BLUE RED over time

    var endGreen = new Array(U[ui].gen+1);
    var endYellow = new Array(U[ui].gen+1);
    var endBlue = new Array(U[ui].gen+1);
    var endRed = new Array(U[ui].gen+1);

    for (i=0;i<U[ui].gen+1; i++){
      endGreen[i] = {y:U[ui].logGreen[i], label:i};
      endYellow[i] = {y:U[ui].logYellow[i], label:i};
      endBlue[i] = {y:U[ui].logBlue[i], label:i};
      endRed[i] = {y:U[ui].logRed[i], label:i};
    }

  var chart4 = new CanvasJS.Chart("chartContainer4", {
  //  theme: "light1",
    colorSet: "Overview GYBRO",
    title:{
      text: "Progress of Transitions"
    },
      data: [
    {
      type: "stackedColumn",
      dataPoints: endGreen
    },  {
      type: "stackedColumn",
      dataPoints: endYellow
    },  {
      type: "stackedColumn",
      dataPoints: endBlue
    },  {
      type: "stackedColumn",
      dataPoints: endRed
    }
      ]
    }
  );
  chart4.render();

  if (!U[ui].ageFlag) return;

// CHART 5 - Age-Based Groups - Numbers T(0) and T(now)

var ageNGreen = new Array(U[ui].ageCount+1);
var ageNYellow = new Array(U[ui].ageCount+1);
var ageNBlue = new Array(U[ui].ageCount+1);
var ageNRed = new Array(U[ui].ageCount+1);
var ageNOrange = new Array(U[ui].ageCount+1);

var perc = 0;
U[ui].pAges[U[ui].ageCount][0] = "Other";         //now we call them visitors
for (i=0;i<U[ui].ageCount+1; i++){
  if (U[ui].pAges[i][4].num != 0){
    perc = (U[ui].pAges[i][4].gre/U[ui].pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNGreen[i] = {y:U[ui].pAges[i][4].gre, label: U[ui].pAges[i][0], no: U[ui].pAges[i][4].num, per: perc };

  if (U[ui].pAges[i][4].num != 0){
    perc = (U[ui].pAges[i][4].yel/U[ui].pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNYellow[i] = {y:U[ui].pAges[i][4].yel, label: U[ui].pAges[i][0], no: U[ui].pAges[i][4].num, per: perc};

  if (U[ui].pAges[i][4].num != 0){
    perc = (U[ui].pAges[i][4].blu/U[ui].pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNBlue[i] = {y:U[ui].pAges[i][4].blu, label: U[ui].pAges[i][0], no: U[ui].pAges[i][4].num, per: perc};

  if (U[ui].pAges[i][4].num != 0){
    perc = (U[ui].pAges[i][4].red/U[ui].pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNRed[i] = {y:U[ui].pAges[i][4].red, label: U[ui].pAges[i][0], no: U[ui].pAges[i][4].num, per: perc};

  if (U[ui].pAges[i][4].num != 0){
    perc = (U[ui].pAges[i][4].ora/U[ui].pAges[i][4].num*100).toFixed(2)
  } else  perc = 0;
  ageNOrange[i] = {y:U[ui].pAges[i][4].ora, label: U[ui].pAges[i][0], no: U[ui].pAges[i][4].num, per: perc};
}

var chart5 = new CanvasJS.Chart("chartContainer5", {
//  theme: "light1",
colorSet: "Overview GYBRO",
title:{
  text: "Progress of Transitions in Age Classes"
},
  data: [
{
  type: "stackedColumn",
  toolTipContent: "<b>Uninfected:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNGreen
},  {
  type: "stackedColumn",
  toolTipContent: "Incubating:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNYellow
},  {
  type: "stackedColumn",
  toolTipContent: "Infectious:</b> {y}<br>{per}% of {no}}",
  dataPoints: ageNBlue
},  {
  type: "stackedColumn",
  toolTipContent: "Diagnosed:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNRed
},  {
  type: "stackedColumn",
  toolTipContent: "Isolated:</b> {y}<br>{per}% of {no}",
  dataPoints: ageNOrange
}
  ]
}
);
chart5.render();
U[ui].pAges[U[ui].ageCount][0] = "--"        // restore for conditionals in program
}


// ******************************************************************************************************
//
//                  NOW WE HAVE THE CODE FOR THE SIMULATION ENGINE ON THE AGENTS
//
// *******************************************************************************************************

function showPop(){                               // we need to figure out just when to increase the gen count
if (U[ui].avgInfRate == 99) alert("In showpop");
//    clearCanvas;
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,canvas.width, canvas.height);
    goPop();    //takes a step and moves the entities
    U[ui].gen++;
    tabulate();

    document.getElementById("dGen").innerHTML = U[ui].gen;
    document.getElementById("grCt").innerHTML = U[ui].greenCt;
    document.getElementById("yeCt").innerHTML = U[ui].yellowCt;
    document.getElementById("blCt").innerHTML = U[ui].blueCt;
    document.getElementById("reCt").innerHTML = U[ui].redCt;

//    alert("test TuringFlag");

    if (U[ui].turingFlag) {               // reset the variables - easy at phase 1
      exeTuring();
    }
}

function exeTuring() {
      var i;
      i = parseInt(U[ui].tur[ui].start)+1;

      if (U[ui].gen <i) return;
      if (U[ui].tur[ui].travel != null && U[ui].tur[ui].travel != "") {
            U[ui].fDist = parseInt(U[ui].tur[ui].travel);
            document.getElementById("dDist").innerHTML = U[ui].fDist;
      };

      if (U[ui].tur[ui].incubate != null || U[ui].tur[ui].incubate != "") {
            U[ui].avgIncDays = parseInt(U[ui].tur[ui].incubate);
            document.getElementById("dIncD").innerHTML = U[ui].avgIncDays;

      };
      if (U[ui].tur[ui].infect != null && U[ui].tur[ui].infect != "") {
            U[ui].avgInfDays = parseInt(U[ui].tur[ui].infect);
            document.getElementById("dInfD").innerHTML = U[ui].avgInfDays;

      };
      if (U[ui].tur[ui].mode != null || U[ui].tur[ui].mode != "") {
            U[ui].infectMode = parseInt(U[ui].tur[ui].mode);
            exeInfMode();
            document.getElementById("dInfM").innerHTML = U[ui].infectMode;

      };
      if (U[ui].tur[ui].factor != null && U[ui].tur[ui].factor != "") {
            U[ui].avgInfRate = parseInt(U[ui].tur[ui].factor);
            exeInfR();
            document.getElementById("dInfR").innerHTML = U[ui].avgInfRate;
      };
      if (U[ui].tur[ui].hazard != null && U[ui].tur[ui].hazard != "") {
            U[ui].radius = parseInt(U[ui].tur[ui].hazard);
            exeRadius();
            document.getElementById("dPrad").innerHTML = U[ui].radius;
      };

      if (U[ui].tur[ui].blues != null && U[ui].tur[ui].blues != "") {
          U[ui].newBlue = parseInt(U[ui].tur[ui].blues);
          addBlues(parseInt(U[ui].newBlue));
          U[ui].newBlue = 0;
          document.getElementById("dCont").innerHTML = U[ui].newBlue;
      }

      turingTable();
      U[ui].turingFlag = false;           // for now till we deal with multiples
}

function turingTable() {
          document.getElementById("dCont").innerHTML = U[ui].newBlue;
          document.getElementById("dDist").innerHTML = U[ui].fDist;
          document.getElementById("dIncD").innerHTML = U[ui].avgIncDays;
          document.getElementById("dInfD").innerHTML = U[ui].avgInfDays;
          document.getElementById("dInfM").innerHTML = U[ui].infectMode;
          document.getElementById("dInfR").innerHTML = U[ui].avgInfRate;
          document.getElementById("dCliD").innerHTML = U[ui].avgClinDays;
          document.getElementById("dPrad").innerHTML = U[ui].radius;
}

function goPop(){
  var i;
  popUpdate();                      //checks transitions
  drawThem();
  changeP();
}

function popUpdate(){
  if (U[ui].avgInfRate == 99) alert("in popupdate");
var i;
for (i=1; i<U[ui].Population+1; i++){
  finddelXY(i);
  U[ui].OldX[i] = U[ui].pX[i];
  U[ui].OldY[i] = U[ui].pY[i];

  checkBounds(i);
  calcDeltas(i);

  U[ui].pX[i] = U[ui].newX[i];
  U[ui].pY[i] = U[ui].newY[i];
  }
}

// PROPOSE A MOVE TO A NEW (X,y) LOCATION

function finddelXY(i){
  var rand, randint;
  if (U[ui].avgInfRate == 99) alert("In finddelXY");
  randint = Math.floor(34*Math.random());
  if (U[ui].pColor[i]=="blue" || U[ui].pColor[i]=="red"){
      U[ui].delX[i] = (U[ui].pSize[i]*4) + U[ui].fDist*U[ui].tRAVEL[randint]
  } else {
      U[ui].delX[i] = (U[ui].pSize[i]/20 + U[ui].fDist/20*U[ui].tRAVEL[randint]);
  }
  randint = Math.floor(34*Math.random());
  if (U[ui].pColor[i]=="blue" || U[ui].pColor[i]=="red"){
      U[ui].delY[i] = (U[ui].pSize[i]*4) + U[ui].fDist*U[ui].tRAVEL[randint]
  } else {
      U[ui].delY[i] = (U[ui].pSize[i]/20 + U[ui].fDist/20*U[ui].tRAVEL[randint]);
  }
  randint = Math.floor(3*Math.random());            //'random direction
  if (U[ui].dIRECTION[randint]==-1){
      U[ui].delX[i] = -U[ui].delX[i];
    } else {
      if (U[ui].dIRECTION[randint]==0){
        U[ui].delX[i]=0;
      }
    }
  randint = Math.floor(3*Math.random());
  if (U[ui].dIRECTION[randint]==-1){
      U[ui].delY[i] = -U[ui].delY[i];
    } else {
        if (U[ui].dIRECTION[randint]==0){
            U[ui].delY[i]=0;
        }
    }
}

// STILL IN MAIN ROUTINE - FROM FINDING A MOVE NOW SEEING IF OUT OF BOUNDS

function checkBounds(i){
  while (U[ui].pX[i] + U[ui].delX[i] > U[ui].xSIZE || U[ui].pX[i] + U[ui].delX[i]<0){
    U[ui].delX[i] = -U[ui].delX[i]*0.5;
  };
  while (U[ui].pY[i] + U[ui].delY[i] > U[ui].ySIZE || U[ui].pY[i] + U[ui].delY[i] <0){
    U[ui].delY[i] = -U[ui].delY[i]*0.5;
  }
  U[ui].newX[i] = U[ui].pX[i] + U[ui].delX[i];
  U[ui].newY[i] = U[ui].pY[i] + U[ui].delY[i];
}

// STILL IN GEOMETRY 0 NOW FINDING THE ANIMATION DELTAS TO MOVE SLIGHTLY

function calcDeltas(i){           //for animation
  U[ui].ddx[i] = Math.floor(parseInt(U[ui].delX[i]/drawCycle));
  if (U[ui].ddx[i] == 0) {
    if (U[ui].delX[i]<0){
      U[ui].ddx[i] = -1
    }
    else {
      U[ui].ddx[i] = 1;
    }
  }
  U[ui].ddy[i] = Math.floor(parseInt(U[ui].delY[i]/drawCycle));
  if (U[ui].ddy[i] == 0) {
    if (U[ui].delY[i]<0){
      U[ui].ddy[i] = -1}
    else {
      U[ui].ddy[i] = 1;
    }
  }
}

// CHANGEP() IS WHEREE THE ACTION IS TO CHANGE STATES

function changeP(){
  if (U[ui].avgInfRate == 99) alert("In changeP");
    if (U[ui].contagion) {
      for (i=1;i<U[ui].Population+1;i++){
        // alert("In ChangeP "+U[ui].pStatus[i]);
      U[ui].pColor[i] = U[ui].pStatus[i];
      //start of cycle - now turn all yellows to blue
      testYellow(i);
      //start of cycle - and turn all blues to red
      testBlue(i);
      //start of cycle - turn Reds to purple out of circulation
      testRed(i);
      //now test for collisions and infections
      collision(i);
    }
  }
 }

 function testYellow(i){
   //*****************************************************
   // when Yellow turns Blue, the Max is stochastic range from current average infectious Days
   // the initial count is zero

   if (U[ui].pStatus[i]!="yellow"){
     return;
   };
     //// alert("Test Yellow "+U[ui].pIncDay[i]);
     U[ui].pIncDay[i]--;    //time to turn BLUE
     if (U[ui].pIncDay[i]==0 || U[ui].pIncDay[i]<0){
       U[ui].pStatus[i]="blue";
       U[ui].pColor[i] = "blue";
       //U[ui].pSize[i]=U[ui].pOldSz[i];           //restore to original size
       U[ui].blueCt++;
       U[ui].yellowCt--;

       if(U[ui].ageFlag){
         var ageR = U[ui].pxAgeGp[i];
         U[ui].pAges[ageR][4].yel--;
         U[ui].pAges[ageR][4].blu++;
       }
       U[ui].pTransMax[i] = Math.floor((Math.random()*U[ui].avgInfDays/3)+(2/3*U[ui].avgInfDays));    //assume this will always be 1 or more
       U[ui].pTransCount[i] = 0;           //will transmit today
       // code follows for infectivity - change U[ui].pSize

       U[ui].pfInfectMode[i] = U[ui].infectMode;

       //NOW CALCULATE ACTUAL INFECTION RATE (size)
       //// alert("pInfect"+pInfectMode[i]);
       if (U[ui].pfInfectMode[i] == 0){    //constant present size
         U[ui].pfInfectRate[i] = 0;
         return;
       };
       if (U[ui].pfInfectMode[i] == 1){    //doubles over duration of BLUE
           U[ui].pfInfectRate[i] = parseFloat(1/U[ui].pTransMax[i]);   //will be adding delta
           //// alert("1+"+U[ui].pfInfectRate[i]);
           return;
       }
       if (U[ui].pfInfectMode[i] == 2){    //triples over duration of BLUE
           U[ui].pfInfectRate[i] = parseFloat(2*(1/U[ui].pTransMax[i]));  //delta is 2X
           //// alert("2+"+U[ui].pfInfectRate[i]);
           return;
       }
       if (U[ui].pfInfectMode[i] == 3){     //compound increase by X% daily
           U[ui].pfInfectRate[i] = U[ui].avgInfRate;
           //// alert("3+"+pInfectRate[i]);
           return;
       }
     }
 }

 function testBlue(i){
   if (U[ui].pStatus[i]=="blue"){
     reSizeBlue(i);
     U[ui].pTransCount[i] = U[ui].pTransCount[i]+1;
     //// alert("BlueDays="+U[ui].pTransCount[i]+","+U[ui].pTransMax[i]);
     if (U[ui].pTransCount[i] > U[ui].pTransMax[i]){
       //now we turn the blue to red
       U[ui].pStatus[i] = "red";
       U[ui].pColor[i] = "red";
       U[ui].redCt++;
       U[ui].blueCt--;

       if (U[ui].ageFlag && U[ui].pxAgeGp[i] == -1){
         U[ui].pAges[U[ui].ageCount][4].red++
         U[ui].pAges[U[ui].ageCount][4].blu--;
       } else {
         if (U[ui].ageFlag && U[ui].pxAgeGp[i] != -1) {
           U[ui].pAges[U[ui].pxAgeGp[i]][4].red++;
           U[ui].pAges[U[ui].pxAgeGp[i]][4].blu--;
         }
       }

       U[ui].pClinCount[i] = 0;
       U[ui].pTransCount[i] = 0;     //reset blue
       U[ui].pTransMax[i] = U[ui].avgInfDays;
       //code for size of red follows
       //U[ui].pSize[i] = radius;
    }
   }
 }

 function reSizeBlue(i){

 /*  if (infectMode==3){
        // alert("pfInfectmode = "+U[ui].pfInfectMode[i]);
        // alert("U[ui].pfInfectRate[i] = "+i+","+U[ui].pfInfectRate[i]);
        // alert("avgInfRate = "+avgInfRate);
   }
 */
   if (U[ui].pTransCount[i]==U[ui].pTransMax[i] || U[ui].pTransCount[i]>U[ui].pTransMax[i]){       //last day - don not grow
     return;
   }
   //// alert("TestBlue "+U[ui].pfInfectMode[i]+);

   if (U[ui].pfInfectMode[i] == 0){    //constant present size do nothing
     return;
   };
   if ((U[ui].pfInfectMode[i] == 1)||(U[ui].pfInfectMode[i]==2)){       //doubles over duration of BLUE
       //// alert("mode 1 and 2 "+ U[ui].pfInfectRate[i]);
       U[ui].pSize[i] = U[ui].pSize[i] + (U[ui].pTransCount[i]*U[ui].pfInfectRate[i]);    //will be adding delta
       //// alert("new size "+U[ui].pSize[i]);
       return;
   }
   if (U[ui].pfInfectMode[i] == 3){     //compound increase by X% daily
       U[ui].pSize[i] = U[ui].pSize[i]*U[ui].pfInfectRate[i];
 //      // alert("newU[ui].pSize[i] = "+i+","+U[ui].pSize[i]);
 //      // alert(U[ui].pSize[i]);
       return;
   }
 }

 function testRed(i){
   if (U[ui].pStatus[i]=="red"){
     U[ui].pClinCount[i]++;
     if (U[ui].pClinCount[i] > U[ui].avgClinDays){
       U[ui].pClinCount[i] = 0;
       U[ui].pStatus[i] = "orange";
       U[ui].pColor[i] = "orange";
       U[ui].orangeCt++;

       if (U[ui].ageFlag && U[ui].pxAgeGp[i] == -1){
         U[ui].pAges[U[ui].ageCount][4].ora++
         U[ui].pAges[ageCount][4].red--;
       } else {
         if (U[ui].ageFlag && U[ui].pxAgeGp[i] != -1) {
           U[ui].pAges[U[ui].pxAgeGp[i]][4].ora++;
           U[ui].pAges[U[ui].pxAgeGp[i]][4].red--;
         }
       }

       U[ui].pSize[i] = 6;
     }
   }
 }



 function collision(i){
   var raDist;
   var interBool = false;
   if (U[ui].avgInfRate == 99) alert("In collision");
   var j;
   for (j=1; j<U[ui].Population+1; j++){
     if (i != j){
       xDelta = (U[ui].pX[i]-U[ui].pX[j])**2;
       yDelta = (U[ui].pY[i]-U[ui].pY[j])**2;
       yLength = Math.sqrt(xDelta+yDelta);
       raDist = parseInt(yLength);

       if (raDist > (U[ui].pSize[i]+U[ui].pSize[j])){
         interBool = false;
       } else {
         interBool = true;
       }
       if (interBool) pChange(i,j);
     }
   }
 }



 function pChange(i,j){
   if (U[ui].avgInfRate == 99) alert("In pChange");
   if (U[ui].pStatus[i] == U[ui].pStatus[j]){
     return;
   } else {
     if ((U[ui].pStatus[i]=="green")||(U[ui].pStatus[j]=="green")){
       modify(i,j);
     }
   }
 }

 function modify(i,j){
   var greenPt, otherPt;

   if (U[ui].avgInfRate == 99) alert("In Modify");
     if (U[ui].pStatus[i]=="green") {
       greenPt=i;
       otherPt=j;
     } else {
       if (U[ui].pStatus[j]=="green"){
         greenPt=j;
         otherPt=i;
       };
     }
     if ((U[ui].pStatus[otherPt]=="orange")||(U[ui].pStatus[otherPt]=="yellow")) {
       return;
     }

     U[ui].pStatus[greenPt] = "yellow";
     U[ui].pColor[greenPt] = "yellow";
     U[ui].yellowCt++;
     U[ui].greenCt--;

     if (U[ui].ageFlag) {
       var ageR = U[ui].pxAgeGp[greenPt];
       U[ui].pAges[ageR][4].gre--;
       U[ui].pAges[ageR][4].yel++;
     }
     U[ui].pIncDay[greenPt] = Math.floor((Math.random()*U[ui].avgIncDays/3)+(2/3*U[ui].avgIncDays));
   }

   function tabulate(){         // UPDATE THE GENERAL TALLY FOR THIS PERIOD
     U[ui].logDay[U[ui].gen] = U[ui].gen;
     U[ui].logGreen[U[ui].gen] = U[ui].greenCt;
     U[ui].logYellow[U[ui].gen] = U[ui].yellowCt;
     U[ui].logBlue[U[ui].gen] = U[ui].blueCt;
     U[ui].logRed[U[ui].gen] = U[ui].redCt;
     U[ui].logOrange[U[ui].gen] = U[ui].orangeCt;
     U[ui].logPop[U[ui].gen] = U[ui].Population;
     U[ui].logTravel[U[ui].gen] = U[ui].fDist;
     U[ui].logIncubate[U[ui].gen] = U[ui].avgIncDays;
     U[ui].logInfectD[U[ui].gen] = U[ui].avgInfDays;
     U[ui].logInfectM[U[ui].gen] = U[ui].infectMode;
     U[ui].logInfGrow[U[ui].gen] = U[ui].avgInfRate;
     U[ui].logRedD[U[ui].gen] = U[ui].avgClinDays;
     U[ui].logPsize[U[ui].gen] = U[ui].radius;
   }


// ******************************************************************************
//
//                 THIS IS A SET OF CONTROL ROUTINES DEALING WITH AUTOMATION
//                 AS A TURING MACHINE WITH PROGRAMMED RESETTING OF PARAMETERS
//
//                 ALSO, CHECKPOINT AND RESTART, AND MOVING FROM ONE UNIVERSE OF
//                 EXECUTION TO ANOTHER ARE IN THESE ROUTINES
//
// *****************************************************************************

function setTuring(){
  var xStr;
  U[ui].turingFlag = true;
  xStr = prompt("Enter Turing Tape commands - refer to PRIMER - list separated by commas");
  U[ui].tur[ui] = new CreateTuring;
  parseXstr(xStr);
}

//    GRAMMAR : BEGIN; TAPE NUMBER; INTERVAL START;

function parseXstr(xStr){                 //we may have to extend the data structure to have more functionality and times
  var i,y,z;                              //but for now this is a start
  if (xStr == "" || xStr == null) return;

  for (i=0; i<13; i++){
    y = xStr.indexOf(";",0);
    if (y== -1) break;
    x = xStr.substring(0,y);
    z = x.indexOf("=",0);
//    alert(x.substr(0,z));
    switch(x.substr(0,z)) {
      case "START":
        U[ui].tur[ui].start = x.substring(z+1);
        break;
      case "BLUES":
        U[ui].tur[ui].blues = x.substring(z+1);        // code block
        break;
        case "TRAVEL":
          U[ui].tur[ui].travel = x.substring(z+1);        // code block
          break;
        case "INCUBATE":
          U[ui].tur[ui].incubate = x.substring(z+1);        // code block
        break;
        case "INFECT":
          U[ui].tur[ui].infect = x.substring(z+1);        // code block
        break;
        case "MODE":
          U[ui].tur[ui].mode = x.substring(z+1);        // code block
        break;
        case "FACTOR":
          U[ui].tur[ui].factor = x.substring(z+1);        // code block
        break;
        case "HAZARD":
          U[ui].tur[ui].hazard = x.substring(z+1);        // code block
        break;
      default:
    }
    xStr = xStr.substring(y+1);
  }
}




// *******************************************************************************
// NOW WE ARE IN THE FREE PROGRAM START SINCE ALL WE HAVE DONE SO FAR IS TO CREATE
// DATA STRUCTURES AND FUNCTIONS

window.onload = function(){
  CanvasJS.addColorSet("Overview GYBRO",
     [
     "#008000",
     "#FFD700",
     "#1E90FF",
     "#FF0000",
     "#FF8C00",
    ]);
}


// ***********************************************************************************************************
//
//                          CONTROL STRUCTURES FOR Universes
//
// ***********************************************************************************************************


alert("about to create a universe");
var U = [];      // system variables in Universe i
var ui = 1;       // universe index

  U[ui] = new Universe;


  initAgeTabs(ui);          //are these universe specific - yes I think so
  initRaceTabs(ui);

  dTable();
  calcRowCol();
  drawBalls(0);   //draw the color of the drawBalls










</script>
</body>

</html>
